<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Legendary Umbrella — Weather</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">
  <meta name="theme-color" content="#0a0f15">
  <style>
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .app{min-height:100vh;display:flex;flex-direction:column;background:#0a0f15;color:#e9f0f8}
    header{padding:14px 16px;border-bottom:1px solid #1b2a3b}
    main{padding:16px;max-width:960px;margin:0 auto}
    .card{background:#0f1620;border:1px solid #1b2a3b;border-radius:14px;padding:16px}
    .muted{opacity:.8}
    .error{background:#2a0f0f;border-color:#5a1d1d}
    button{cursor:pointer;border:1px solid #1b2a3b;background:#111a27;color:#e9f0f8;border-radius:10px;padding:10px 14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > * {flex:0 0 auto}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Legendary Umbrella — Weather</h1>
    <div class="muted">Ceol Gan Eagla</div>
  </header>

  <main>
    <div class="card" id="status">Loading…</div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <button id="btnGeo">Use my location</button>
        <input id="city" placeholder="Enter city (e.g., Dublin)" />
        <button id="btnCity">Get weather</button>
      </div>
      <p class="muted" style="margin-top:8px">This build fetches the API key from Vercel even when hosted on GitHub Pages.</p>
      <pre class="mono" id="out" style="white-space:pre-wrap;margin-top:12px"></pre>
    </div>

    <div class="card error" id="err" style="display:none;margin-top:12px"></div>
  </main>
</div>

<script>
/*
  === IMPORTANT FIX ===
  If we are on GitHub Pages (no server), call the Vercel API using an absolute URL.
  If running on Vercel or localhost, use the relative /api path.
*/
const ON_VERCEL = location.hostname.endsWith('.vercel.app');
const ON_GHPAGES = location.hostname.endsWith('github.io');
const ON_LOCAL = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

const VERCEL_ORIGIN = 'https://legendary-umbrella-ashen.vercel.app'; // your deployment shown in repo
const API_BASE = (ON_VERCEL || ON_LOCAL) ? '' : VERCEL_ORIGIN; // '' means same-origin (Vercel), absolute for GH Pages

const els = {
  status: document.getElementById('status'),
  out: document.getElementById('out'),
  err: document.getElementById('err'),
  btnGeo: document.getElementById('btnGeo'),
  city: document.getElementById('city'),
  btnCity: document.getElementById('btnCity'),
};

function showError(msg) {
  els.err.style.display = 'block';
  els.err.textContent = msg;
}
function clearError() {
  els.err.style.display = 'none';
  els.err.textContent = '';
}

async function getTioKey() {
  // Your serverless function that returns the Tomorrow.io key
  const url = `${API_BASE}/api/tio-key`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) {
    throw new Error(`Failed to reach ${url} → ${r.status} ${r.statusText}`);
  }
  const data = await r.json();
  if (!data || !data.key) throw new Error('tio-key endpoint returned no key.');
  return data.key;
}

async function fetchWeatherByLatLon(lat, lon, apiKey) {
  // Example Tomorrow.io v4 endpoint (adjust to your exact usage)
  const url = `https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1h&units=metric&apikey=${encodeURIComponent(apiKey)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`Tomorrow.io error: ${r.status} ${r.statusText}`);
  return r.json();
}

async function geocodeCity(name, apiKey) {
  // Tomorrow.io geocoding convenience; swap for your preferred geocoder if different
  const url = `https://api.tomorrow.io/v4/locations?search=${encodeURIComponent(name)}&apikey=${encodeURIComponent(apiKey)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`Geocode error: ${r.status} ${r.statusText}`);
  const data = await r.json();
  const loc = data?.locations?.[0];
  if (!loc) throw new Error('City not found.');
  return { lat: loc.lat, lon: loc.lon, resolved: `${loc.name}, ${loc.countryCode}` };
}

async function boot() {
  try {
    clearError();
    els.status.textContent = 'Booting…';

    const key = await getTioKey();
    els.status.innerHTML = `API base: <b>${API_BASE || '(same-origin)'}</b> — key ✓`;

    els.btnGeo.onclick = async () => {
      try {
        clearError();
        els.out.textContent = 'Getting location…';
        const pos = await new Promise((res, rej) => {
          navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 });
        });
        const { latitude, longitude } = pos.coords;
        els.out.textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)} — fetching…`;
        const data = await fetchWeatherByLatLon(latitude, longitude, key);
        els.out.textContent = JSON.stringify(data, null, 2);
      } catch (e) { showError(e.message); }
    };

    els.btnCity.onclick = async () => {
      try {
        clearError();
        const name = (els.city.value || '').trim();
        if (!name) { showError('Type a city name.'); return; }
        els.out.textContent = `Resolving “${name}”…`;
        const loc = await geocodeCity(name, key);
        els.out.textContent = `Found ${loc.resolved} (${loc.lat}, ${loc.lon}) — fetching…`;
        const data = await fetchWeatherByLatLon(loc.lat, loc.lon, key);
        els.out.textContent = JSON.stringify(data, null, 2);
      } catch (e) { showError(e.message); }
    };

    // Register SW (cache bump)
    if ('serviceWorker' in navigator) {
      try { await navigator.serviceWorker.register('./sw.js?v=4'); } catch {}
    }

  } catch (e) {
    showError(
      `Startup failed: ${e.message}\n\nIf you are on GitHub Pages, make sure the Vercel deployment is live:\n${VERCEL_ORIGIN}`
    );
    els.status.textContent = 'Failed to boot.';
  }
}

boot();
</script>
</body>
</html>
