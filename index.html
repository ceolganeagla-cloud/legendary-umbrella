<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Legendary Umbrella â€” Marine Weather & Nav</title>
<link rel="icon" href="favicon.ico">
<meta name="theme-color" content="#0a0f15">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#0a0f15; --panel:#0f1620; --card:#111a27; --line:#1b2a3b;
    --ink:#e9f0f8; --muted:#9fb2c8; --accent:#22c55e; --warn:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  .brand{padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1a26}
  .status{margin-left:auto;font-size:12px;color:var(--muted)}
  main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:1100px;margin:0 auto}
  @media(min-width:1000px){ main{grid-template-columns:1fr 380px;} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  #map{height:60vh;min-height:420px;border-radius:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:#b6c6d8}
  button,.btn{
    border:1px solid var(--line);background:#111a27;color:var(--ink);
    border-radius:12px;padding:10px 12px;font:inherit;line-height:1;display:inline-flex;align-items:center;gap:.5rem
  }
  .btn.active,button.active{ background-color:var(--accent); border-color:var(--accent); color:#fff; }
  button:disabled{ opacity:.6; cursor:wait; }
  input{background:#0e1320;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;min-width:220px}
  pre{white-space:pre-wrap;max-height:42vh;overflow:auto;background:#0b121c;border-radius:10px;padding:10px;border:1px solid var(--line)}
  .error{background:#2a0f0f;border-color:#5a1d1d}
  .good{color:var(--accent)}
  .metric{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:14px}
  .metric b{color:var(--ink)}
  .chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-right:6px;background:#0e1724}
  .veh{ filter: drop-shadow(0 0 2px rgba(0,0,0,.6)); }
  .leaflet-tooltip.my-tooltip{
    background:var(--card);color:var(--ink);font-weight:600;padding:6px 8px;border-radius:6px;border:1px solid var(--line);box-shadow:0 6px 22px rgba(0,0,0,.35)
  }
  /* Speedometer */
  .speedo{display:grid;place-items:center;padding:16px}
  .gauge{width:220px;height:110px;background:conic-gradient(#1f2b3a 0 180deg);
    border-bottom-left-radius:220px;border-bottom-right-radius:220px;position:relative;border:1px solid var(--line)}
  .needle{position:absolute;left:50%;bottom:0;transform-origin:bottom center;width:2px;height:100px;background:#eaeaea;box-shadow:0 0 6px rgba(255,255,255,.6)}
  .ticks{position:absolute;left:0;top:0;width:100%;height:100%}
  .speed-read{margin-top:8px;font-size:28px;font-weight:700;text-align:center}
  .units{font-size:12px;color:var(--muted);text-align:center;margin-top:-6px}
  /* Loading pill */
  .loading-pill{display:none;align-items:center;gap:.5rem;font-size:12px;background:#0e1724;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:999px}
  .loading-pill.show{display:inline-flex}
  /* Legend */
  .legend{position:absolute;z-index:500;bottom:10px;left:10px;background:#0e1724;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:12px}
  .legend .row{display:flex;align-items:center;gap:6px;margin:4px 0}
  /* Forecast strip */
  .forecast{display:flex;gap:8px;overflow:auto;padding-top:8px}
  .fx{min-width:90px;border:1px solid var(--line);border-radius:10px;padding:6px;background:#0b121c}
  .fx b{display:block;font-size:13px;margin-bottom:4px}
  button:focus-visible{outline:2px solid #60a5fa;outline-offset:2px}
  @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }
</style>
</head>
<body>
<header>
  <div class="brand">Ceol Gan Eagla</div>
  <h1>Legendary Umbrella â€” Marine Weather & Nav</h1>
  <div class="status" id="status" role="status" aria-live="polite">Bootingâ€¦</div>
</header>

<main>
  <!-- LEFT: Map + Controls -->
  <section>
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <button id="btnTrack">Start tracking</button>
        <button id="btnCenter">Center on me</button>
        <button id="btnFull">Fullscreen map</button>
        <span class="muted">Layers: </span>
        <button id="btnOSM" class="btn active">OSM</button>
        <button id="btnOcean" class="btn">Ocean</button>
        <button id="btnSat" class="btn">Satellite</button>
        <button id="btnSeamark" class="btn">Seamarks</button>
        <button id="btnDepth" class="btn">Depth</button>
        <button id="btnRivers" class="btn">Rivers</button>
        <button id="btnHarbours" class="btn">Harbours</button>
        <button id="btnFuel" class="btn">Fuel</button>
        <button id="btnPiers" class="btn">Piers</button>
        <button id="btnAircraft" class="btn">Aircraft</button>
        <button id="btnBoats" class="btn">Boats</button>
      </div>

      <div style="position:relative">
        <div id="map" aria-label="Navigation map"></div>
        <!-- Legend -->
        <div class="legend" role="region" aria-label="Map legend">
          <div class="row"><img alt="" width="16" height="16" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><polygon points='8,0 16,8 8,16 0,8' fill='%23ffffff'/></svg>"><span>Aircraft (rotates with track)</span></div>
          <div class="row"><img alt="" width="16" height="16" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><rect width='16' height='10' y='3' rx='3' fill='%23ffffff'/></svg>"><span>Vessels (rotates with COG)</span></div>
          <div class="row"><span style="display:inline-block;width:16px;height:3px;background:#62b0ff"></span><span>Rivers/Waterways</span></div>
          <div class="row"><span style="display:inline-block;width:16px;height:16px;border:1px solid #9fb2c8"></span><span>Seamarks / Depth tiles</span></div>
        </div>
      </div>

      <div class="muted" style="margin-top:6px">
        Basemaps: <span class="chip">OpenStreetMap</span> <span class="chip">Esri World Ocean</span>
        <span class="chip">Esri Imagery</span> â€¢ Overlays:
        <span class="chip">OpenSeaMap Seamarks</span> <span class="chip">Depth</span>
        <span class="chip">Rivers</span> <span class="chip">Harbours</span> <span class="chip">Fuel</span> <span class="chip">Piers</span>.
      </div>
    </div>

    <div class="card" id="wxCard" style="margin-top:12px">
      <div class="row" style="margin-bottom:6px">
        <button id="btnGeo">Use my location</button>
        <input id="city" placeholder="Enter city (e.g., Dublin)" aria-label="City name"/>
        <button id="btnCity">Get weather</button>
        <span class="loading-pill" id="wxLoading" aria-live="polite" aria-atomic="true">
          <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity=".25"/>
            <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="3" fill="none">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
            </path>
          </svg>
          loadingâ€¦
        </span>
        <span class="muted" style="margin-left:auto">API base: <b id="apiBaseTxt">â€”</b></span>
      </div>

      <div class="metric" id="wx">
        <div class="muted">Temp:</div><b id="mTemp">â€”</b>
        <div class="muted">Wind:</div><b id="mWind">â€”</b>
        <div class="muted">Gust:</div><b id="mGust">â€”</b>
        <div class="muted">Direction:</div><b id="mDir">â€”</b>
        <div class="muted">Precip Prob:</div><b id="mPop">â€”</b>
        <div class="muted">Cloud Cover:</div><b id="mCloud">â€”</b>
      </div>

      <!-- mini forecast strip -->
      <div id="forecast" class="forecast" aria-label="Next 8 hours forecast"></div>

      <pre id="raw" style="display:none"></pre>
      <div id="err" class="card error" style="display:none;margin-top:8px"></div>
    </div>
  </section>

  <!-- RIGHT: Speedometer + Info -->
  <aside class="rightcol">
    <div class="card speedo">
      <div class="gauge" id="gauge">
        <div class="needle" id="needle" style="transform:translateX(-50%) rotate(180deg)"></div>
        <svg class="ticks" viewBox="0 0 100 50" preserveAspectRatio="none">
          <g stroke="#334a63" stroke-width="0.6">
            <line x1="5" y1="48" x2="5" y2="44"/>
            <line x1="15" y1="48" x2="15" y2="44"/>
            <line x1="25" y1="48" x2="25" y2="44"/>
            <line x1="35" y1="48" x2="35" y2="44"/>
            <line x1="45" y1="48" x2="45" y2="44"/>
            <line x1="55" y1="48" x2="55" y2="44"/>
            <line x1="65" y1="48" x2="65" y2="44"/>
            <line x1="75" y1="48" x2="75" y2="44"/>
            <line x1="85" y1="48" x2="85" y2="44"/>
            <line x1="95" y1="48" x2="95" y2="44"/>
          </g>
        </svg>
      </div>
      <div class="speed-read" id="spd">0.0</div>
      <div class="units">knots (kn)</div>
      <div class="muted" style="text-align:center;margin-top:6px">Uses GPS speed; falls back to distance over time if speed is missing.</div>
    </div>

    <div class="card">
      <div class="muted">Position</div>
      <div class="metric">
        <div class="muted">Lat:</div><b id="pLat">â€”</b>
        <div class="muted">Lon:</div><b id="pLon">â€”</b>
        <div class="muted">Acc:</div><b id="pAcc">â€”</b>
        <div class="muted">Bearing:</div><b id="pBrg">â€”</b>
      </div>
    </div>
  </aside>
</main>

<script>
/* ===== Rotated Marker helper (inline) ===== */
(function(){
  const proto=L.Marker.prototype, _setPos=proto._setPos;
  proto._setPos=function(pos){
    _setPos.call(this,pos);
    if(!this.options.rotationAngle) return;
    this._icon.style.transformOrigin=this.options.rotationOrigin||"center";
    const a=this.options.rotationAngle;
    const t=(this._icon.style.transform||'').replace(/ ?rotate\\(.*\\)/,'');
    this._icon.style.transform=t+' rotate('+a+'deg)';
  };
  proto.setRotationAngle=function(a){this.options.rotationAngle=a; this.update();};
})();

/*** ====== HOSTING / API BASE ====== ***/
const ON_VERCEL = location.hostname.endsWith('.vercel.app');
const ON_LOCAL = ['localhost','127.0.0.1'].includes(location.hostname);
const VERCEL_ORIGIN = 'https://legendary-umbrella-ashen.vercel.app';
const API_BASE = (ON_VERCEL || ON_LOCAL) ? '' : VERCEL_ORIGIN;
document.getElementById('apiBaseTxt').textContent = API_BASE || '(same-origin)';

/*** ====== DOM utils & UX helpers ====== ***/
const $ = id => document.getElementById(id);
const setStatus = t => $('status').textContent = t;
const showErr = msg => { const e=$('err'); e.style.display='block'; e.textContent=msg; };
const clearErr=()=>{ const e=$('err'); e.style.display='none'; e.textContent=''; };
const showLoading = (id,on=true)=>{ const el=$(id); if(!el) return; el.classList[on?'add':'remove']('show'); };
const debounce = (fn, delay=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; };

/*** ====== WEATHER HELPERS ====== ***/
let __TIO_KEY=null;
async function getTioKeyCached(){ if(__TIO_KEY) return __TIO_KEY; const r=await fetch(`${API_BASE}/api/tio-key`,{cache:'no-store'}); if(!r.ok) throw new Error('tio-key '+r.status); const j=await r.json(); if(!j?.key) throw new Error('No key'); __TIO_KEY=j.key; return __TIO_KEY; }
async function tmrForecastByLatLon(lat,lon,key){
  const url=`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1h&units=metric&apikey=${encodeURIComponent(key)}`;
  const r=await fetch(url); if(!r.ok) throw new Error('Tomorrow.io '+r.status); return r.json();
}
async function tmrGeocodeCity(name,key){
  const url=`https://api.tomorrow.io/v4/locations?search=${encodeURIComponent(name)}&apikey=${encodeURIComponent(key)}`;
  const r=await fetch(url); if(!r.ok) throw new Error('Geocode '+r.status); const j=await r.json(); const loc=j?.locations?.[0]; if(!loc) throw new Error('City not found'); return { lat:loc.lat, lon:loc.lon, resolved:`${loc.name}, ${loc.countryCode}` };
}
function setWX(data){
  const point = data?.timelines?.hourly?.[0];
  if(!point){ $('raw').style.display='block'; $('raw').textContent=JSON.stringify(data,null,2); return; }
  const v = point.values || {};
  $('mTemp').textContent = (v.temperature ?? 'â€”') + ' Â°C';
  $('mWind').textContent = (v.windSpeed ?? 'â€”') + ' m/s';
  $('mGust').textContent = (v.windGust ?? 'â€”') + ' m/s';
  $('mDir').textContent  = (v.windDirection ?? 'â€”') + 'Â°';
  $('mPop').textContent  = (v.precipitationProbability ?? 'â€”') + ' %';
  $('mCloud').textContent= (v.cloudCover ?? 'â€”') + ' %';
  setForecastStrip(data);
}
function fmtHour(ts){
  try{ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch{ return 'â€”'; }
}
function setForecastStrip(data){
  const hourly = data?.timelines?.hourly || [];
  const fx = hourly.slice(0,8); // next 8 hours
  const el = $('forecast'); el.innerHTML='';
  fx.forEach(h=>{
    const v=h.values||{};
    const temp = v.temperature!=null ? `${Math.round(v.temperature)}Â°C`:'â€”';
    const wind = v.windSpeed!=null ? `${Math.round(v.windSpeed)} m/s`:'â€”';
    const pop  = v.precipitationProbability!=null ? `${Math.round(v.precipitationProbability)}%`:'â€”';
    const cloud= v.cloudCover!=null ? `${Math.round(v.cloudCover)}%`:'â€”';
    const box = document.createElement('div');
    box.className='fx';
    box.innerHTML = `<b>${fmtHour(h.time)}</b>
      <div>Temp: ${temp}</div>
      <div>Wind: ${wind}</div>
      <div>Precip: ${pop}</div>
      <div>Cloud: ${cloud}</div>`;
    el.appendChild(box);
  });
}

/*** ====== MAP & LAYERS ====== ***/
let map, meMarker, meAccuracy, trackId=null, lastFix=null;
let osm, ocean, sat, seamark, depthTiles;
const riversLayer=L.layerGroup(), harboursLayer=L.layerGroup(), fuelLayer=L.layerGroup(), piersLayer=L.layerGroup();
const aircraftLayer=L.layerGroup(), boatsLayer=L.layerGroup();

function initMap(){
  map = L.map('map',{center:[53.35,-6.26],zoom:10,minZoom:2});
  // basemaps
  osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
  ocean = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',{maxZoom:13, attribution:'Esri Ocean'});
  sat   = L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19, attribution:'Esri Imagery'});
  // overlays
  seamark = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png',{maxZoom:18,opacity:.95,attribution:'OpenSeaMap'});
  depthTiles = L.tileLayer('https://tiles.openseamap.org/depth/{z}/{x}/{y}.png',{maxZoom:18,opacity:.6,attribution:'OpenSeaMap Depth'});

  // base buttons
  const baseBtns=[$('btnOSM'),$('btnOcean'),$('btnSat')];
  function setActive(btn){ baseBtns.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
  $('btnOSM').onclick   = ()=>{ [ocean,sat].forEach(l=>map.removeLayer(l)); if(!map.hasLayer(osm)) osm.addTo(map); setActive($('btnOSM')); };
  $('btnOcean').onclick = ()=>{ [osm,sat].forEach(l=>map.removeLayer(l)); if(!map.hasLayer(ocean)) ocean.addTo(map); setActive($('btnOcean')); };
  $('btnSat').onclick   = ()=>{ [osm,ocean].forEach(l=>map.removeLayer(l)); if(!map.hasLayer(sat))   sat.addTo(map);   setActive($('btnSat')); };

  // overlay buttons
  $('btnSeamark').onclick = ()=> toggleOverlay(seamark, 'btnSeamark');
  $('btnDepth').onclick   = ()=> toggleOverlay(depthTiles, 'btnDepth');
  $('btnRivers').onclick  = ()=> toggleDataLayer('rivers','btnRivers');
  $('btnHarbours').onclick= ()=> toggleDataLayer('harbours','btnHarbours');
  $('btnFuel').onclick    = ()=> toggleDataLayer('fuel','btnFuel');
  $('btnPiers').onclick   = ()=> toggleDataLayer('piers','btnPiers');

  $('btnFull').onclick = ()=>{
    const el=$('map'); if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
  };
  $('btnCenter').onclick = ()=>{ if(lastFix){ map.setView([lastFix.coords.latitude,lastFix.coords.longitude], Math.max(14,map.getZoom())); } };

  setTimeout(()=> map.invalidateSize(), 0);
}
function toggleOverlay(layer, btnId){
  const btn=$(btnId);
  if(map.hasLayer(layer)){ map.removeLayer(layer); btn.classList.remove('active'); }
  else { layer.addTo(map); btn.classList.add('active'); }
}

/*** ====== GEO / SPEEDO ====== ***/
const R = 6371000;
const toRad = d=>d*Math.PI/180;
const haversine=(a,b)=>{ const Ï†1=toRad(a.lat),Ï†2=toRad(b.lat),dÏ†=toRad(b.lat-a.lat),dÎ»=toRad(b.lon-a.lon); const s=Math.sin(dÏ†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2; return 2*R*Math.asin(Math.sqrt(s)); };
const msToKn = ms => (ms*1.943844)||0;
function setNeedle(kn){ kn=Math.max(0,Math.min(50,kn)); const deg=180-(kn/50)*180; $('needle').style.transform=`translateX(-50%) rotate(${deg}deg)`; $('spd').textContent=kn.toFixed(1); }
function updateMeMarker(lat,lon,acc,brg){
  if(!meMarker){ meMarker=L.marker([lat,lon]).addTo(map); meAccuracy=L.circle([lat,lon],{radius:acc||0,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.12}).addTo(map); }
  else{ meMarker.setLatLng([lat,lon]); meAccuracy.setLatLng([lat,lon]).setRadius(acc||0); }
  $('pLat').textContent=lat.toFixed(5); $('pLon').textContent=lon.toFixed(5);
  $('pAcc').textContent=acc? acc.toFixed(0)+' m':'â€”'; $('pBrg').textContent=Number.isFinite(brg)? Math.round(brg)+'Â°':'â€”';
}
let watchId=null, wxTimer=null;
$('btnTrack').onclick = ()=>{
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; $('btnTrack').textContent='Start tracking'; if(wxTimer){clearInterval(wxTimer); wxTimer=null;} return; }
  watchId = navigator.geolocation.watchPosition(async pos=>{
    lastFix=pos; const {latitude:lat,longitude:lon,accuracy:acc,heading,speed} = pos.coords;
    updateMeMarker(lat,lon,acc,heading);
    let mps = Number.isFinite(speed)&&speed!==null ? speed : null;
    if(!mps && window.__prevFix){ const dt=(pos.timestamp-window.__prevFix.timestamp)/1000; if(dt>0){ const d= haversine({lat:window.__prevFix.coords.latitude,lon:window.__prevFix.coords.longitude},{lat,lon}); mps=d/dt; } }
    window.__prevFix=pos; setNeedle(msToKn(mps||0));
  }, e=>showErr('GPS error: '+e.message), {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  $('btnTrack').textContent='Trackingâ€¦';
};

/*** ======= LIVE LAYERS: AIRCRAFT & BOATS ======= */
let aircraftTimer=null, boatsTimer=null;
// crisp inline SVG icons (faster than PNG)
const PLANE_SVG = "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="white" d="M33 6l6 18 19 8-1 4-18-2-6 10 4 12h-4l-6-12-18 2-1-4 19-8 6-18z"/></svg>`);
const BOAT_SVG  = "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="white" d="M8 38l24-10 24 10-8 12H16z"/><path fill="white" d="M32 10l8 18H24z"/></svg>`);
const planeIcon = L.icon({ iconUrl: PLANE_SVG, iconSize:[24,24], iconAnchor:[12,12] });
const boatIcon  = L.icon({ iconUrl: BOAT_SVG,  iconSize:[24,24], iconAnchor:[12,12] });

async function fetchAircraftBBox(){
  const b = map.getBounds();
  const qs = new URLSearchParams({ n:b.getNorth(), s:b.getSouth(), e:b.getEast(), w:b.getWest() });
  const r = await fetch(`${API_BASE}/api/opensky?${qs}`, { cache:'no-store' });
  if(!r.ok) throw new Error('OpenSky '+r.status);
  return r.json();
}
async function refreshAircraft(){
  try{
    const data=await fetchAircraftBBox();
    aircraftLayer.clearLayers();
    const states=data.states||[];
    for(const s of states){
      const callsign=(s[1]||'').trim();
      const lon=s[5], lat=s[6]; if(lat==null||lon==null) continue;
      const gs=s[9]; const track=s[10]; const alt=s[13];
      L.marker([lat,lon], { icon:planeIcon, rotationAngle:track||0, rotationOrigin:'center' })
        .bindTooltip(callsign || 'Aircraft', { className:'my-tooltip', direction:'top', offset:[0,-10], sticky:true })
        .bindPopup(`<b>âœˆ ${callsign || 'Unknown'}</b><br>
          Speed: ${gs ? (gs*1.943844).toFixed(1)+' kn' : 'â€”'}<br>
          Track: ${track==null ? 'â€”' : Math.round(track)+'Â°'}<br>
          Alt: ${alt==null ? 'â€”' : Math.round(alt*3.28084)+' ft'}<br>
          ICAO24: ${s[0]||'â€”'}`)
        .addTo(aircraftLayer);
    }
  }catch(e){ console.warn(e); }
}
async function refreshBoats(){
  try{
    const r=await fetch(`${API_BASE}/api/ais`, { cache:'no-store' });
    if(!r.ok) throw new Error('AIS '+r.status);
    const list=await r.json();
    boatsLayer.clearLayers();
    (list||[]).forEach(v=>{
      if(v.lat==null||v.lon==null) return;
      const title = v.name || v.mmsi || 'Vessel';
      L.marker([v.lat,v.lon], { icon:boatIcon, rotationAngle:v.cog||0, rotationOrigin:'center' })
        .bindTooltip(title, { className:'my-tooltip', direction:'top', offset:[0,-10], sticky:true })
        .bindPopup(`<b>â›µ ${title}</b><br>
          SOG: ${v.sog!=null? Number(v.sog).toFixed(1)+' kn':'â€”'}<br>
          COG: ${v.cog!=null? Math.round(v.cog)+'Â°':'â€”'}<br>
          ${v.mmsi? 'MMSI: '+v.mmsi : ''}`)
        .addTo(boatsLayer);
    });
  }catch(e){ console.warn(e); }
}
async function guardedToggle(toggleFn, btnId){
  const btn=$(btnId); if(btn?.disabled) return; btn.disabled=true;
  try{ await toggleFn(); btn.classList.toggle('active'); } catch(e){ showErr(e.message); } finally{ btn.disabled=false; }
}
$('btnAircraft').onclick = ()=> guardedToggle(()=> {
  if(map.hasLayer(aircraftLayer)){ map.removeLayer(aircraftLayer); if(aircraftTimer){clearInterval(aircraftTimer); aircraftTimer=null;} }
  else{ aircraftLayer.addTo(map); refreshAircraft(); aircraftTimer=setInterval(refreshAircraft, 10000); }
}, 'btnAircraft');

$('btnBoats').onclick = ()=> guardedToggle(()=> {
  if(map.hasLayer(boatsLayer)){ map.removeLayer(boatsLayer); if(boatsTimer){clearInterval(boatsTimer); boatsTimer=null;} }
  else{ boatsLayer.addTo(map); refreshBoats(); boatsTimer=setInterval(refreshBoats, 15000); }
}, 'btnBoats');

/*** ====== OSM DATA: Rivers, Harbours, Fuel, Piers (Overpass) ====== */
const overpass = q => fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q}).then(r=>{ if(!r.ok) throw new Error('Overpass '+r.status); return r.json(); });
const bboxStr = ()=>{ const b=map.getBounds(); return `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`; };
const reloadIf = (layer, loader) => { if(map.hasLayer(layer)) loader().catch(console.warn); };
const debMove = debounce(()=>{ reloadIf(riversLayer,loadRivers); reloadIf(harboursLayer,loadHarbours); reloadIf(fuelLayer,loadFuel); reloadIf(piersLayer,loadPiers); }, 600);
function toggleDataLayer(kind, btnId){
  const btn=$(btnId);
  const toggle=(layer, loader)=>{
    if(map.hasLayer(layer)){ map.removeLayer(layer); btn.classList.remove('active'); map.off('moveend',debMove); map.on('moveend',debMove); }
    else{ layer.addTo(map); loader().catch(console.warn); btn.classList.add('active'); map.off('moveend',debMove); map.on('moveend',debMove); }
  };
  if(kind==='rivers')   return toggle(riversLayer,  loadRivers);
  if(kind==='harbours') return toggle(harboursLayer,loadHarbours);
  if(kind==='fuel')     return toggle(fuelLayer,    loadFuel);
  if(kind==='piers')    return toggle(piersLayer,   loadPiers);
}
async function loadRivers(){
  const q=`[out:json][timeout:25];(way["waterway"~"river|stream|canal"](${bboxStr()}););out geom;`;
  const j=await overpass(q); riversLayer.clearLayers();
  (j.elements||[]).forEach(w=>{ if(!w.geometry) return; const latlngs=w.geometry.map(p=>[p.lat,p.lon]); L.polyline(latlngs,{color:'#62b0ff',weight:2,opacity:.85}).addTo(riversLayer); });
}
async function loadHarbours(){
  const q=`[out:json][timeout:25];(node["seamark:type"="harbour"](${bboxStr()}); node["leisure"="marina"](${bboxStr()}););out center;`;
  const j=await overpass(q); harboursLayer.clearLayers();
  (j.elements||[]).forEach(e=>{ const lat=e.lat??e.center?.lat, lon=e.lon??e.center?.lon; if(lat==null||lon==null) return; L.marker([lat,lon]).bindPopup(`<b>âš“ ${e.tags?.name||'Harbour/Marina'}</b>`).addTo(harboursLayer); });
}
async function loadFuel(){
  const q=`[out:json][timeout:25];(node["amenity"="fuel"](${bboxStr()}););out center;`;
  const j=await overpass(q); fuelLayer.clearLayers();
  (j.elements||[]).forEach(e=>{ const lat=e.lat??e.center?.lat, lon=e.lon??e.center?.lon; if(lat==null||lon==null) return; L.marker([lat,lon]).bindPopup(`<b>â›½ ${e.tags?.name||'Fuel'}</b>`).addTo(fuelLayer); });
}
async function loadPiers(){
  const q=`[out:json][timeout:25];(way["man_made"="pier"](${bboxStr()}); relation["man_made"="pier"](${bboxStr()}););out center;`;
  const j=await overpass(q); piersLayer.clearLayers();
  (j.elements||[]).forEach(e=>{ const lat=e.lat??e.center?.lat, lon=e.lon??e.center?.lon; if(lat==null||lon==null) return; L.marker([lat,lon]).bindPopup(`<b>ðŸ›¶ ${e.tags?.name||'Pier'}</b>`).addTo(piersLayer); });
}

/*** ====== WEATHER CONTROLS / BOOT ====== ***/
$('btnCity').onclick = debounce(async ()=>{
  try{
    clearErr(); showLoading('wxLoading', true); setStatus('Fetching city & weatherâ€¦');
    const name = ($('city').value || '').trim();
    if(!name) return showErr('Please enter a city name.');
    const key = await getTioKeyCached();
    const loc = await tmrGeocodeCity(name, key);
    const data = await tmrForecastByLatLon(loc.lat, loc.lon, key);
    setWX(data); map.setView([loc.lat,loc.lon], 11);
    setStatus(`Weather for ${loc.resolved || name}`);
  }catch(e){ showErr(e.message); setStatus('Failed to fetch weather.'); }
  finally{ showLoading('wxLoading', false); }
}, 500);

$('btnGeo').onclick = async ()=>{
  try{
    clearErr(); showLoading('wxLoading', true); setStatus('Getting your locationâ€¦');
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:10000}));
    const {latitude, longitude}=pos.coords; const key=await getTioKeyCached();
    const data = await tmrForecastByLatLon(latitude, longitude, key);
    setWX(data); map.setView([latitude,longitude], 11); setStatus('Weather updated');
    if(wxTimer) clearInterval(wxTimer);
    wxTimer=setInterval(async ()=>{ try{
      const p = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:10000}));
      const d = await tmrForecastByLatLon(p.coords.latitude, p.coords.longitude, key);
      setWX(d); setStatus('Weather auto-refreshed');
    }catch(_){} }, 10*60*1000);
  }catch(e){ showErr(e.message); setStatus('Location/weather failed.'); }
  finally{ showLoading('wxLoading', false); }
};

async function boot(){
  try{
    clearErr(); setStatus('Bootingâ€¦'); initMap();
    await getTioKeyCached(); setStatus(`API base: ${API_BASE||'(same-origin)'} â€” key âœ“`);
  }catch(e){ showErr('Startup failed: '+e.message); setStatus('Failed to boot.'); }
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
