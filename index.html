<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ceol Gan Eagla â€” Weather</title>

<link rel="manifest" href="manifest.webmanifest" />
<link rel="icon" href="favicon.ico" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#0d1117;--panel:#151a22;--card:#1c2330;--muted:#aab2c0;--accent:#3aa0ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px}
  header img{width:64px;height:64px;object-fit:contain;border-radius:12px;background:#000}
  header h1{font-size:22px;margin:0}
  header small{display:block;color:var(--muted)}
  #map{height:58vh;width:100%}
  /* Move zoom so it doesn't block popups */
  .leaflet-control-zoom{position:absolute;right:10px;bottom:10px;left:auto;top:auto}

  .panel{background:var(--panel);margin:10px auto;padding:12px;border-radius:14px;max-width:980px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
  .row > *{margin:4px}
  input[type="text"]{min-width:240px;padding:10px;border-radius:10px;border:1px solid #2a3342;background:#111;color:#fff}
  button,select{padding:10px 12px;border-radius:10px;border:1px solid #2a3342;background:#111;color:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#000}
  .slider{display:flex;align-items:center;gap:10px}
  .slider input[type="range"]{width:180px}

  .cards{display:flex;gap:10px;overflow-x:auto;padding:10px}
  .card{min-width:120px;background:var(--card);padding:10px;border-radius:12px}
  .card h4{margin:0 0 6px 0;font-weight:600}
  .meta{color:var(--muted);font-size:13px}

  /* GPS bottom bar just under map (not overlaying it) */
  #gpsbar{background:rgba(0,0,0,.7);padding:8px 12px;text-align:center;border-top:1px solid #2a3342}
  #gpsbar button{background:#222;border:1px solid #3a4356}

  @media (max-width:600px){
    header h1{font-size:18px}
    #map{height:54vh}
  }
</style>
</head>
<body>

<header class="panel" style="display:flex;justify-content:space-between;max-width:980px">
  <div style="display:flex;align-items:center;gap:12px">
    <img src="icon-192.png" alt="Ceol Gan Eagla logo" />
    <div>
      <h1>Ceol Gan Eagla â€” Weather</h1>
      <small>Sources: OSM Â· MapTiler Â· RainViewer Â· Open-Meteo Â· Nominatim</small>
    </div>
  </div>
</header>

<div id="map"></div>

<!-- GPS BAR (beneath map) -->
<div id="gpsbar">
  <span id="gpsLoc">ğŸ“ locatingâ€¦</span> Â·
  <span id="gpsSpeed">â±ï¸ 0 km/h</span>
  <button id="unitBtn" title="Toggle speed units">km/h â–¸ mph</button>
</div>

<!-- Controls -->
<div class="panel">
  <div class="row">
    <button id="meBtn" class="primary">ğŸ“ Me</button>
    <button id="pinBtn">ğŸ“Œ Pin</button>

    <label>Units
      <select id="unitsSel">
        <option value="metric" selected>Metric</option>
        <option value="imperial">Imperial</option>
      </select>
    </label>

    <label>Map
      <select id="mapSel">
        <option value="streets" selected>Streets</option>
        <option value="satellite">Satellite</option>
      </select>
    </label>

    <input id="searchBox" type="text" placeholder="Search place or Eircodeâ€¦" />
    <button id="searchBtn">ğŸ”</button>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="radarBtn" class="primary">Radar On</button>
    <button id="cloudBtn">Clouds Off</button>
    <div class="slider">
      <span>Opacity</span>
      <input id="opacityRange" type="range" min="20" max="100" value="70" />
    </div>
    <div class="slider" id="radarControls" style="display:none">
      <button id="playBtn">â–¶ï¸</button>
      <input id="radarRange" type="range" min="0" max="0" value="0" />
      <span id="radarTime" class="meta">--:--</span>
    </div>
    <button id="refreshBtn">â†» Refresh</button>
  </div>

  <div class="meta" style="margin-top:8px">
    Sources: Map Â© OpenStreetMap; Tiles Â© MapTiler; Radar & Satellite Â© RainViewer; Forecast Â© Open-Meteo; Geocoding Â© Nominatim/OSM.
  </div>
</div>

<!-- Weather info -->
<div class="panel" id="nowPanel">
  <div id="nowLine" class="meta">Loading forecastâ€¦</div>
  <div id="extras" class="meta"></div>
</div>

<div class="panel">
  <h3>Next 24 hours</h3>
  <div id="hourly" class="cards"></div>
</div>

<div class="panel">
  <h3>7-day forecast</h3>
  <div id="daily" class="cards"></div>
</div>

<script>
/* ===========================
   Map & Base Layers (MapTiler)
=========================== */
const MT_KEY = "MpDV384cXMNO273WsuTG";

const layers = {
  streets: L.tileLayer(`https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MT_KEY}`, {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://www.maptiler.com/">MapTiler</a>'
  }),
  satellite: L.tileLayer(`https://api.maptiler.com/maps/satellite-v2/256/{z}/{x}/{y}.jpg?key=${MT_KEY}`, {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://www.maptiler.com/">MapTiler</a>'
  })
};

const map = L.map('map', { zoomControl: true, center:[53.3498,-6.2603], zoom:7, layers:[layers.streets] });
let pin = L.marker([53.3498,-6.2603], {draggable:false}).addTo(map);

/* Move zoom to bottom-right (CSS already handles) */

/* ===========================
   Controls
=========================== */
const unitsSel = document.getElementById('unitsSel');
const mapSel = document.getElementById('mapSel');
const searchBox = document.getElementById('searchBox');
const searchBtn = document.getElementById('searchBtn');
const meBtn = document.getElementById('meBtn');
const pinBtn = document.getElementById('pinBtn');
const radarBtn = document.getElementById('radarBtn');
const cloudBtn = document.getElementById('cloudBtn');
const opacityRange = document.getElementById('opacityRange');
const radarControls = document.getElementById('radarControls');
const radarRange = document.getElementById('radarRange');
const radarTime = document.getElementById('radarTime');
const playBtn = document.getElementById('playBtn');
const refreshBtn = document.getElementById('refreshBtn');

mapSel.addEventListener('change', () => {
  const sel = mapSel.value;
  if (sel === 'streets') { map.removeLayer(layers.satellite); layers.streets.addTo(map); }
  else { map.removeLayer(layers.streets); layers.satellite.addTo(map); }
});

searchBtn.addEventListener('click', async () => {
  const q = searchBox.value.trim();
  if (!q) return;
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const res = await fetch(url, {headers:{'Accept-Language':'en'}});
  const j = await res.json();
  if (j.length) {
    const { lat, lon } = j[0];
    moveTo(+lat, +lon, 11, true);
  }
});

meBtn.addEventListener('click', () => {
  if (!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(p => {
    moveTo(p.coords.latitude, p.coords.longitude, 12, true);
  }, ()=>alert('Unable to get your location'), {enableHighAccuracy:true});
});

pinBtn.addEventListener('click', ()=>{
  const c = map.getCenter(); moveTo(c.lat, c.lng, map.getZoom(), true);
});

opacityRange.addEventListener('input', ()=>{
  const o = Number(opacityRange.value)/100;
  if (rv.currentLayer) rv.currentLayer.setOpacity(o);
  if (rv.cloudLayer) rv.cloudLayer.setOpacity(o*0.8);
});

refreshBtn.addEventListener('click', ()=>{ loadForecast(pin.getLatLng()); rv.load(); });

/* ===========================
   RainViewer Radar (animated)
=========================== */
const rv = {
  frames: [],
  pos: 0,
  timer: null,
  currentLayer: null,
  cloudFrames: [],
  cloudLayer: null,
  on: false,
  clouds: false,
  async load(){
    try{
      const f = await fetch('https://tilecache.rainviewer.com/api/maps.json');
      const arr = await f.json();
      rv.frames = arr.radar || arr; // compatibility
      rv.cloudFrames = arr.satellite || [];
      radarRange.max = rv.frames.length ? rv.frames.length-1 : 0;
      rv.showFrame(rv.frames.length-1);
      radarControls.style.display = rv.on ? 'flex':'none';
    }catch(e){ console.warn('RainViewer error', e); }
  },
  tile(ts, type='radar'){
    // 2 = color scheme, 1_1 = smoothing
    return `https://tilecache.rainviewer.com/v2/${type}/${ts}/256/{z}/{x}/{y}/2/1_1.png`;
  },
  showFrame(idx){
    if (!rv.frames.length) return;
    rv.pos = Math.max(0, Math.min(idx, rv.frames.length-1));
    radarRange.value = rv.pos;
    const ts = rv.frames[rv.pos];
    radarTime.textContent = new Date(ts*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const opacity = Number(opacityRange.value)/100;

    // Radar
    const layer = L.tileLayer(rv.tile(ts,'radar'), {opacity, zIndex: 400});
    if (rv.currentLayer) map.removeLayer(rv.currentLayer);
    rv.currentLayer = layer; if (rv.on) layer.addTo(map);

    // Optional clouds using satellite frames (if provided by RainViewer)
    if (rv.clouds && rv.cloudFrames.length){
      const cts = rv.cloudFrames[Math.max(0, Math.min(rv.pos, rv.cloudFrames.length-1))];
      const cl = L.tileLayer(rv.tile(cts,'satellite'), {opacity: opacity*0.8, zIndex: 350});
      if (rv.cloudLayer) map.removeLayer(rv.cloudLayer);
      rv.cloudLayer = cl; cl.addTo(map);
    }else{
      if (rv.cloudLayer) { map.removeLayer(rv.cloudLayer); rv.cloudLayer = null; }
    }
  },
  play(){
    if (rv.timer || !rv.frames.length) return;
    playBtn.textContent = 'â¸';
    rv.timer = setInterval(()=>{
      rv.showFrame((rv.pos+1)%rv.frames.length);
    }, 650);
  },
  pause(){
    playBtn.textContent = 'â–¶ï¸';
    if (rv.timer){ clearInterval(rv.timer); rv.timer = null; }
  }
};

radarBtn.addEventListener('click', ()=>{
  rv.on = !rv.on;
  radarBtn.textContent = rv.on ? 'Radar On' : 'Radar Off';
  radarControls.style.display = rv.on ? 'flex' : 'none';
  if (rv.on){ if (rv.currentLayer) rv.currentLayer.addTo(map); rv.load(); }
  else { if (rv.currentLayer) map.removeLayer(rv.currentLayer); rv.pause(); }
});

cloudBtn.addEventListener('click', ()=>{
  rv.clouds = !rv.clouds;
  cloudBtn.textContent = rv.clouds ? 'Clouds On' : 'Clouds Off';
  rv.showFrame(rv.pos);
});

radarRange.addEventListener('input', ()=> rv.showFrame(+radarRange.value));
playBtn.addEventListener('click', ()=> rv.timer ? rv.pause() : rv.play());

/* ===========================
   Open-Meteo Forecast
=========================== */
const nowLine = document.getElementById('nowLine');
const extras = document.getElementById('extras');
const hourlyDiv = document.getElementById('hourly');
const dailyDiv = document.getElementById('daily');

function icon(code, night=false){
  // Simple set; expand if you like
  const m = {
    0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'ğŸŒ«ï¸',
    51:'ğŸŒ¦ï¸',53:'ğŸŒ¦ï¸',55:'ğŸŒ§ï¸',61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',
    71:'â„ï¸',73:'â„ï¸',75:'â„ï¸',80:'ğŸŒ§ï¸',81:'ğŸŒ§ï¸',82:'ğŸŒ§ï¸',95:'â›ˆï¸',96:'â›ˆï¸',99:'â›ˆï¸'
  };
  return (night && (code===0||code===1)) ? 'ğŸŒ™' : (m[code]||'ğŸŒ¡ï¸');
}
function kmhToMph(k){ return k*0.621371; }
function msToMph(ms){ return ms*2.23694; }
function mmToIn(mm){ return mm/25.4; }

async function loadForecast(ll){
  const lat = ll.lat.toFixed(4), lon = ll.lng.toFixed(4);
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
              `&hourly=temperature_2m,precipitation,cloudcover,weathercode,snowfall`+
              `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset,weathercode`+
              `&current_weather=true&timezone=auto`;
  const r = await fetch(url); const j = await r.json();

  const metric = (unitsSel.value === 'metric');
  const tNow = j.current_weather.temperature; // Â°C
  const windKmh = j.current_weather.windspeed; // km/h
  const tNowTxt = metric ? `${tNow}Â°C` : `${Math.round(tNow*9/5+32)}Â°F`;
  const windTxt = metric ? `${Math.round(windKmh)} km/h` : `${Math.round(kmhToMph(windKmh))} mph`;
  nowLine.textContent = `${icon(j.current_weather.weathercode)} ${tNowTxt} Â· Wind ${windTxt} Â· Cloud ${j.hourly.cloudcover[0] ?? 0}%`;

  const sr = j.daily.sunrise[0], ss = j.daily.sunset[0];
  extras.textContent = `Sunrise ${sr.slice(11,16)} Â· Sunset ${ss.slice(11,16)}`;

  // Hourly next 24h
  hourlyDiv.innerHTML = '';
  for (let i=0;i<24 && i<j.hourly.time.length;i++){
    const h = document.createElement('div'); h.className='card';
    const tc = j.hourly.temperature_2m[i];
    const pp = j.hourly.precipitation[i];
    const code = j.hourly.weathercode[i];
    h.innerHTML = `<h4>${j.hourly.time[i].slice(11,16)}</h4>
      <div style="font-size:22px">${icon(code)}</div>
      <div>${metric ? Math.round(tc)+'Â°C' : Math.round(tc*9/5+32)+'Â°F'}</div>
      <div class="meta">${metric ? pp+' mm' : (pp?mmToIn(pp).toFixed(2)+' in':'0 in')}</div>`;
    hourlyDiv.appendChild(h);
  }

  // Daily 7-day
  dailyDiv.innerHTML = '';
  for (let i=0;i<j.daily.time.length;i++){
    const d = document.createElement('div'); d.className='card';
    const tmax = j.daily.temperature_2m_max[i];
    const tmin = j.daily.temperature_2m_min[i];
    const pr = j.daily.precipitation_sum[i]||0;
    const code = j.daily.weathercode[i];
    d.innerHTML = `<h4>${j.daily.time[i].slice(5)}</h4>
      <div style="font-size:22px">${icon(code)}</div>
      <div>${metric ? Math.round(tmax)+'Â° / '+Math.round(tmin)+'Â°C'
                     : Math.round(tmax*9/5+32)+'Â° / '+Math.round(tmin*9/5+32)+'Â°F'}</div>
      <div class="meta">${metric ? pr+' mm' : (pr?mmToIn(pr).toFixed(2)+' in':'0 in')}</div>`;
    dailyDiv.appendChild(d);
  }
}

function moveTo(lat, lon, zoom=10, setPin=false){
  map.setView([lat,lon], zoom);
  if (setPin){ pin.setLatLng([lat,lon]); loadForecast(pin.getLatLng()); }
}

/* First load */
loadForecast(pin.getLatLng());

/* Units toggle re-renders the panels with current data */
unitsSel.addEventListener('change', ()=> loadForecast(pin.getLatLng()));

/* ===========================
   GPS bottom bar: coords + speed
=========================== */
let speedUnit = 'kmh'; // cycles: kmh -> mph -> knots
const gpsLoc = document.getElementById('gpsLoc');
const gpsSpeed = document.getElementById('gpsSpeed');
const unitBtn = document.getElementById('unitBtn');

unitBtn.addEventListener('click', ()=>{
  speedUnit = (speedUnit==='kmh') ? 'mph' : (speedUnit==='mph' ? 'knots' : 'kmh');
  unitBtn.textContent =
    speedUnit==='kmh' ? 'km/h â–¸ mph' :
    speedUnit==='mph' ? 'mph â–¸ knots' : 'knots â–¸ km/h';
});

function fmtSpeed(ms){
  if (ms==null || isNaN(ms)) return '0';
  if (speedUnit==='kmh') return (ms*3.6).toFixed(1)+' km/h';
  if (speedUnit==='mph') return (ms*2.23694).toFixed(1)+' mph';
  return (ms*1.94384).toFixed(1)+' kn';
}

if (navigator.geolocation){
  navigator.geolocation.watchPosition(p=>{
    const {latitude,longitude,speed} = p.coords;
    gpsLoc.textContent = `ğŸ“ ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
    gpsSpeed.textContent = `â±ï¸ ${fmtSpeed(speed)}`;
  },err=>{
    gpsLoc.textContent = 'ğŸ“ location unavailable';
  },{enableHighAccuracy:true,maximumAge:2000,timeout:10000});
}

/* Load RainViewer once on start (user can toggle) */
rv.load();
</script>
</body>
</html>
