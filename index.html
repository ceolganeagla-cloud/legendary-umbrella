<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ceol Gan Eagla ‚Äî Weather</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0b1220"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0b1220;--panel:#12141c;--card:#1a1e29;--text:#eaeaea;--muted:#b9b9c2;
  --accent:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:1fr 420px;gap:12px;height:100vh;padding:12px}
#map{width:100%;height:100%;border-radius:16px;overflow:hidden}
aside{background:var(--panel);border-radius:16px;overflow:auto;padding:12px}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.logo{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#000;flex:0 0 48px}
.logo img{width:100%;height:100%;object-fit:contain;background:#fff} /* CONTAINED LOGO */
h1{font-size:18px;margin:0}.sub{color:var(--muted);font-size:12px}

.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:0;padding:8px 10px;border-radius:10px;background:var(--accent);color:#111;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
select, input[type=text]{background:#0f131c;color:var(--text);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px}
input[type=range]{width:180px}

#hourly{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px}
.hour{min-width:90px;padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.hour .ico{width:26px;height:26px;margin:6px auto}

#daily{display:grid;grid-template-columns:repeat(7,minmax(90px,1fr));gap:8px}
.day{padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.day .ico{width:26px;height:26px;margin:6px auto}

#searchWrap{position:relative}
#suggest{position:absolute;left:0;right:0;top:44px;background:#0f131c;border:1px solid rgba(255,255,255,.15);border-radius:10px;overflow:hidden;display:none;max-height:240px;overflow:auto;z-index:20}
.item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer}
.item:hover{background:rgba(255,255,255,.06)}

.chip{padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.06);font-size:12px}

.map-badge{position:absolute;left:10px;top:10px;background:rgba(18,18,22,.88);color:#fff;
  border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:8px;font-size:12px;z-index:450}

@media (max-width:860px){.app{grid-template-columns:1fr;grid-template-rows:50vh 1fr}}
</style>
</head>
<body>
<div class="app">
  <div id="map"></div>

  <aside>
    <div class="brand">
      <div class="logo">
        <img src="./logo.png" alt="Ceol Gan Eagla Logo"
             onerror="this.onerror=null;this.src='./icon-192.png'">
      </div>
      <div>
        <h1>Ceol Gan Eagla ‚Äî Weather</h1>
        <div class="sub">Sources: OSM ‚Ä¢ MapTiler ‚Ä¢ RainViewer ‚Ä¢ Open-Meteo ‚Ä¢ Nominatim</div>
      </div>
    </div>

    <div class="card" id="searchWrap">
      <input id="search" placeholder="Search place or Eircode‚Ä¶"/>
      <div id="suggest"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnGeo" class="btn">üìç Me</button>
        <button id="btnPin"  class="btn ghost">üìå Pin</button>
        <label>Units
          <select id="units" class="btn ghost">
            <option value="metric" selected>Metric (¬∞C)</option>
            <option value="imperial">Imperial (¬∞F)</option>
          </select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div id="nowIcon"></div>
        <div class="chip" id="temp">‚Äî</div>
        <div class="chip" id="wind">Wind ‚Äî</div>
        <div class="chip" id="precip">Precip ‚Äî</div>
        <div class="chip" id="cloud">Cloud ‚Äî</div>
        <div class="chip" id="sun">Sunrise ‚Äî / Sunset ‚Äî</div>
        <div class="chip" id="risk">‚Äî</div>
        <div class="chip" id="updated">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="play" class="btn ghost">‚ñ∂Ô∏é</button>
        <input id="frame" type="range" min="0" max="0" step="1" value="0"/>
        <span id="frametime" class="sub">‚Äî</span>
        <label style="margin-left:auto">Opacity <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.7"/></label>
        <button id="refresh" class="btn ghost">‚Üª</button>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Next 24 hours</div>
      <div id="hourly">Loading‚Ä¶</div>
    </div>
    <div class="card">
      <div class="sub" style="margin-bottom:6px">7-day forecast</div>
      <div id="daily">Loading‚Ä¶</div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== CONFIG ====== */
const MT = 'MpDV384cXMNO273WsuTG'; // MapTiler key you provided

/* ====== MAP ====== */
const map = L.map('map', { zoomControl: true }).setView([53.35,-6.26], 7);
const base = L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MT}`, {
  attribution: '&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler'
}).addTo(map);

/* Radar pane (above tiles) */
map.createPane('radar'); map.getPane('radar').style.zIndex = 450;
const radar = L.tileLayer('', {pane:'radar', opacity:0.7}).addTo(map);

/* Badge on map */
const badge = L.control({position:'topleft'});
badge.onAdd = () => {
  const div = L.DomUtil.create('div','map-badge');
  div.id='badge';
  div.innerHTML = 'Locating‚Ä¶';
  return div;
};
badge.addTo(map);

/* ====== ELEMENTS ====== */
const Q = (id)=>document.getElementById(id);
const el = {
  units: Q('units'),
  badge: Q('badge'),
  frame: Q('frame'),
  play: Q('play'),
  frametime: Q('frametime'),
  opacity: Q('opacity'),
  updated: Q('updated'),
  temp: Q('temp'), wind: Q('wind'), precip: Q('precip'), cloud: Q('cloud'),
  sun: Q('sun'), risk: Q('risk'), nowIcon: Q('nowIcon'),
  hourly: Q('hourly'), daily: Q('daily'),
  search: Q('search'), suggest: Q('suggest')
};

/* ====== HELPERS ====== */
const toF = c => Math.round(c*9/5+32);
const msToMph = ms => Math.round(ms*2.23694);
const mmToIn = mm => Math.round(mm/25.4*100)/100;
const wIcon = code => '‚òÅ'; // simple placeholder icon

/* ====== RADAR (RainViewer latest + frames) ====== */
let RV = { frames: [], index: 0, timer: null };

async function loadRadar() {
  try {
    const r = await fetch('https://api.rainviewer.com/public/weather-maps.json', {cache:'no-store'});
    const j = await r.json();
    RV.frames = (j.radar?.past || []).concat(j.radar?.nowcast || []);
    el.frame.max = Math.max(RV.frames.length-1, 0);
    setRadar(RV.frames.length-1); // jump to latest
  } catch(e) {
    // ignore
  }
}
function setRadar(i) {
  RV.index = Math.max(0, Math.min(i, RV.frames.length-1));
  const fr = RV.frames[RV.index];
  if (!fr) return;
  const url = `https://tilecache.rainviewer.com/v2/radar/${fr.time}/256/{z}/{x}/{y}/2/1_1.png`;
  radar.setUrl(url);
  el.frametime.textContent = new Date(fr.time*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
el.frame.addEventListener('input', e => setRadar(+e.target.value));
el.play.addEventListener('click', () => {
  if (RV.timer) { clearInterval(RV.timer); RV.timer=null; el.play.textContent='‚ñ∂Ô∏é'; return; }
  el.play.textContent='‚è∏';
  RV.timer = setInterval(()=>{
    const next = (RV.index+1) % RV.frames.length;
    el.frame.value = next; setRadar(next);
  }, 700);
});
el.opacity.addEventListener('input', e => radar.setOpacity(+e.target.value));
Q('refresh').addEventListener('click', loadRadar);

/* ====== GEO + SEARCH ====== */
Q('btnGeo').addEventListener('click', () => {
  navigator.geolocation?.getCurrentPosition(pos=>{
    const {latitude:lat, longitude:lon} = pos.coords;
    map.setView([lat, lon], 10);
    updateWeather(lat, lon, 'My location');
  });
});
Q('btnPin').addEventListener('click', () => {
  const c = map.getCenter(); L.marker(c).addTo(map);
  updateWeather(c.lat, c.lng, 'Pinned point');
});

el.search.addEventListener('keydown', e => { if (e.key==='Enter') doSearch(); });
el.search.addEventListener('input', debounce(suggest, 200));

async function doSearch() {
  const q = el.search.value.trim();
  if (!q) return;
  const eir = /^[A-Z0-9]{3}\s?[A-Z0-9]{4}$/i;
  const url = eir.test(q)
    ? `https://nominatim.openstreetmap.org/search?postalcode=${q.replace(/\s+/g,'')}&countrycodes=ie&format=json&addressdetails=1&limit=5`
    : `https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, {headers:{'Accept-Language':navigator.language||'en'}});
  const j = await r.json();
  el.suggest.innerHTML = ''; el.suggest.style.display = 'none';
  if (!j.length) return;
  const {lat, lon, display_name} = j[0];
  map.setView([+lat, +lon], 10);
  L.marker([+lat,+lon]).addTo(map).bindPopup(display_name).openPopup();
  updateWeather(+lat, +lon, display_name);
}
async function suggest() {
  const q = el.search.value.trim();
  if (!q) { el.suggest.style.display='none'; return; }
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`, {headers:{'Accept-Language':'en'}});
  const j = await r.json();
  el.suggest.innerHTML = j.map(o=>`<div class="item" data-lat="${o.lat}" data-lon="${o.lon}">${o.display_name}</div>`).join('');
  el.suggest.style.display = j.length ? 'block' : 'none';
}
el.suggest.addEventListener('click', e=>{
  const it = e.target.closest('.item'); if (!it) return;
  const lat = +it.dataset.lat, lon = +it.dataset.lon;
  const name = it.textContent;
  el.suggest.style.display = 'none';
  map.setView([lat,lon], 10); L.marker([lat,lon]).addTo(map).bindPopup(name).openPopup();
  updateWeather(lat, lon, name);
});
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

/* ====== WEATHER (Open-Meteo) ====== */
async function updateWeather(lat, lon, label='') {
  el.badge.textContent = label ? `${label} ‚Ä¢ Lat ${lat.toFixed(3)}, Lon ${lon.toFixed(3)}` : `Lat ${lat.toFixed(3)}, Lon ${lon.toFixed(3)}`;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
    + `&current_weather=true`
    + `&hourly=temperature_2m,precipitation,cloudcover,windspeed_10m,weathercode,snowfall`
    + `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset`
    + `&forecast_days=7&timezone=auto`;
  const r = await fetch(url, {cache:'no-store'}); const j = await r.json();

  const metric = el.units.value === 'metric';
  const cNow = j.current_weather;
  const tC = Math.round(cNow?.temperature ?? 0);
  const windMs = j.hourly?.windspeed_10m?.[0] ?? 0;
  const pMm = j.hourly?.precipitation?.[0] ?? 0;
  const cl  = j.hourly?.cloudcover?.[0] ?? 0;
  const snow = j.hourly?.snowfall?.[0] ?? 0;
  const sunrise = j.daily.sunrise?.[0], sunset = j.daily.sunset?.[0];

  el.nowIcon.textContent = wIcon(cNow?.weathercode ?? 0);
  el.temp.textContent   = metric ? `${tC}¬∞C` : `${toF(tC)}¬∞F`;
  el.wind.textContent   = metric ? `Wind ${Math.round(windMs)} m/s` : `Wind ${msToMph(windMs)} mph`;
  el.precip.textContent = metric ? `Precip ${pMm} mm` : `Precip ${mmToIn(pMm)} in`;
  el.cloud.textContent  = `Cloud ${cl}%`;
  el.sun.textContent    = `Sunrise ${new Date(sunrise).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} / Sunset ${new Date(sunset).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;
  el.risk.textContent   = (snow>0?'‚ùÑ snow':'') + ((cl<=0 && pMm>0)?' ‚Ä¢ üåß rain':'') + (snow>0?' ‚Ä¢ üßä ice risk':'');
  el.updated.textContent= `Updated ${new Date().toLocaleTimeString()}`;

  // 24h
  el.hourly.innerHTML = '';
  for (let i=0;i<24;i++){
    const ti = j.hourly.time[i].slice(11,16);
    const tc = j.hourly.temperature_2m[i];
    const pp = j.hourly.precipitation[i];
    const card = document.createElement('div');
    card.className='hour';
    card.innerHTML = `${ti}<div class="ico">${wIcon(j.hourly.weathercode[i])}</div>`
      + `${metric? Math.round(tc)+'¬∞C' : toF(tc)+'¬∞F'}<br>`
      + `${metric? pp+' mm' : mmToIn(pp)+' in'}`;
    el.hourly.appendChild(card);
  }
  // 7-day
  el.daily.innerHTML = '';
  for (let i=0;i<7;i++){
    const wd = new Date(j.daily.time[i]).toLocaleDateString(undefined,{weekday:'short'});
    const tmax = j.daily.temperature_2m_max[i], tmin = j.daily.temperature_2m_min[i];
    const d = document.createElement('div'); d.className='day';
    d.innerHTML = `${wd}<div class="ico">${wIcon(0)}</div>`
      + `${metric? Math.round(tmax)+'¬∞C / '+Math.round(tmin)+'¬∞C'
               : toF(tmax)+'¬∞F / '+toF(tmin)+'¬∞F'}<br>`
      + `${metric? (j.daily.precipitation_sum?.[i]??0)+' mm' : mmToIn(j.daily.precipitation_sum?.[i]??0)+' in'}`;
    el.daily.appendChild(d);
  }
}

/* units change -> recompute display at current center */
el.units.addEventListener('change', ()=>{
  const c = map.getCenter();
  updateWeather(c.lat, c.lng, 'Updated units');
});

/* ====== START ====== */
loadRadar();
setInterval(loadRadar, 5*60*1000); // refresh radar every 5 min
navigator.geolocation?.getCurrentPosition(
  pos => { const {latitude:lat, longitude:lon} = pos.coords; map.setView([lat,lon],10); updateWeather(lat,lon,'My location'); },
  ()  => { updateWeather(53.35,-6.26,'Dublin area'); }
);
</script>
</body>
</html>
