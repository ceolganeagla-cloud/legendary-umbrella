<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ceol Gan Eagla â€” Weather</title>

  <!-- PWA manifest + icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Leaflet + MapTiler -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #fff;
      text-align: center;
    }
    header {
      padding: 10px;
    }
    header img {
      max-width: 100px;
      height: auto;
      border-radius: 12px;
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    #controls {
      padding: 10px;
    }
    .forecast {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px;
    }
    .forecast-day {
      background: #222;
      padding: 10px;
      border-radius: 8px;
      width: 80px;
    }
    #gps-bar {
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 14px;
      padding: 8px;
      text-align: center;
      position: relative;
      bottom: 0;
      width: 100%;
      border-top: 1px solid #333;
    }
    #gps-bar button {
      background: #444;
      border: none;
      color: #fff;
      padding: 4px 8px;
      margin-left: 6px;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <img src="icon-192.png" alt="Ceol Gan Eagla Logo">
    <h2>Ceol Gan Eagla â€” Weather</h2>
    <small>Sources: OSM â€¢ MapTiler â€¢ Open-Meteo â€¢ RainViewer</small>
  </header>

  <!-- Map -->
  <div id="map"></div>

  <!-- Controls -->
  <div id="controls">
    <input type="text" id="search" placeholder="Search place or Eircodeâ€¦">
    <button onclick="searchLocation()">ğŸ”</button>
  </div>

  <!-- Weather info -->
  <div id="info">
    <p id="now">Loading current weatherâ€¦</p>
    <p id="sun"></p>
    <p id="risk"></p>
    <p id="updated"></p>
  </div>

  <!-- Forecast -->
  <h3>7-day forecast</h3>
  <div id="forecast" class="forecast"></div>

  <!-- GPS Bottom Bar -->
  <div id="gps-bar">
    <span id="gps-location">ğŸ“ Locatingâ€¦</span> |
    <span id="gps-speed">â±ï¸ Speed: 0 km/h</span> |
    <button onclick="toggleUnits()">Toggle Units</button>
  </div>

  <script>
    // ======================
    // Map Setup
    // ======================
    const map = L.map('map').setView([53.3498, -6.2603], 8);
    L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=YOUR_MAPTILER_KEY`, {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://www.maptiler.com/">MapTiler</a>'
    }).addTo(map);

    let marker = L.marker([53.3498, -6.2603]).addTo(map);

    // ======================
    // Weather API
    // ======================
    async function getWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,cloudcover,weathercode,snowfall&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,snowfall_sum&current_weather=true&timezone=auto`;
      const res = await fetch(url);
      const data = await res.json();

      document.getElementById("now").textContent =
        `ğŸŒ¡ï¸ Now: ${data.current_weather.temperature}Â°C, Wind ${data.current_weather.windspeed} km/h`;

      document.getElementById("sun").textContent =
        `â˜€ï¸ Sunrise: ${data.daily.sunrise[0].slice(11,16)} | ğŸŒ™ Sunset: ${data.daily.sunset[0].slice(11,16)}`;

      document.getElementById("risk").textContent =
        `â„ï¸ Snow: ${data.daily.snowfall_sum[0]}mm | ğŸŒ§ï¸ Rain: ${data.daily.precipitation_sum[0]}mm`;

      document.getElementById("updated").textContent = `Last update: ${new Date().toLocaleTimeString()}`;

      const forecast = document.getElementById("forecast");
      forecast.innerHTML = "";
      for (let i = 0; i < data.daily.time.length; i++) {
        const day = document.createElement("div");
        day.className = "forecast-day";
        day.innerHTML = `
          <strong>${data.daily.time[i].slice(5)}</strong><br>
          ğŸŒ¡ï¸ ${data.daily.temperature_2m_max[i]}Â° / ${data.daily.temperature_2m_min[i]}Â°<br>
          ğŸŒ§ï¸ ${data.daily.precipitation_sum[i]}mm
        `;
        forecast.appendChild(day);
      }
    }

    getWeather(53.3498, -6.2603);

    function searchLocation() {
      const place = document.getElementById("search").value;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${place}`)
        .then(r => r.json())
        .then(d => {
          if (d.length > 0) {
            const lat = d[0].lat, lon = d[0].lon;
            map.setView([lat, lon], 10);
            marker.setLatLng([lat, lon]);
            getWeather(lat, lon);
          }
        });
    }

    // ======================
    // GPS Speed + Location
    // ======================
    let speedUnit = "kmh";

    function toggleUnits() {
      if (speedUnit === "kmh") speedUnit = "mph";
      else if (speedUnit === "mph") speedUnit = "knots";
      else speedUnit = "kmh";
    }

    function convertSpeed(ms) {
      if (speedUnit === "kmh") return (ms * 3.6).toFixed(1) + " km/h";
      if (speedUnit === "mph") return (ms * 2.23694).toFixed(1) + " mph";
      if (speedUnit === "knots") return (ms * 1.94384).toFixed(1) + " knots";
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(5);
          const lon = pos.coords.longitude.toFixed(5);
          document.getElementById("gps-location").textContent = `ğŸ“ ${lat}, ${lon}`;

          const speed = pos.coords.speed;
          document.getElementById("gps-speed").textContent =
            "â±ï¸ Speed: " + (speed ? convertSpeed(speed) : "0");
        },
        err => {
          document.getElementById("gps-location").textContent = "ğŸ“ Location unavailable";
          console.error(err);
        },
        { enableHighAccuracy: true }
      );
    } else {
      document.getElementById("gps-location").textContent = "ğŸ“ Geolocation not supported";
    }
  </script>
</body>
</html>
