<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ceol Gan Eagla ‚Äî Weather & Marine</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0b1220"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#0b1220;--panel:#12141c;--card:#1a1e29;--text:#eaeaea;--muted:#b9b9c2;--accent:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:1fr 440px;gap:12px;height:100vh;padding:12px}
#map{width:100%;height:100%;border-radius:16px;overflow:hidden;position:relative}
aside{background:var(--panel);border-radius:16px;overflow:auto;padding:12px}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.logo{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#000;flex:0 0 48px}
.logo img{width:100%;height:100%;object-fit:contain;background:#fff} /* contained logo */
h1{font-size:18px;margin:0}.sub{color:var(--muted);font-size:12px}

.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:0;padding:8px 10px;border-radius:10px;background:var(--accent);color:#111;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
select, input[type=text]{background:#0f131c;color:var(--text);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px}
input[type=range]{width:180px}

#hourly{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px}
.hour{min-width:96px;padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.hour .ico{width:26px;height:26px;margin:6px auto}

#daily{display:grid;grid-template-columns:repeat(7,minmax(96px,1fr));gap:8px}
.day{padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.day .ico{width:26px;height:26px;margin:6px auto}

#searchWrap{position:relative}
#suggest{position:absolute;left:0;right:0;top:44px;background:#0f131c;border:1px solid rgba(255,255,255,.15);border-radius:10px;overflow:hidden;display:none;max-height:240px;overflow:auto;z-index:20}
.item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer}
.item:hover{background:rgba(255,255,255,.06)}

.chip{padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.06);font-size:12px}

/* On-map badge that never blocks controls */
.map-badge{position:absolute;left:10px;top:10px;background:rgba(18,18,22,.9);color:#fff;
  border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:8px;font-size:12px;z-index:450;pointer-events:none}

/* Move zoom controls out of the way */
.leaflet-control-zoom{margin:10px}
.leaflet-top.leaflet-left .leaflet-control-zoom{margin-top:56px} /* leave space for badge */

@media (max-width:920px){.app{grid-template-columns:1fr;grid-template-rows:50vh 1fr}}
</style>
</head>
<body>
<div class="app">
  <div id="map">
    <div id="badge" class="map-badge">Locating‚Ä¶</div>
  </div>

  <aside>
    <div class="brand">
      <div class="logo"><img src="icon-192.png" alt="Ceol Gan Eagla Logo"></div>
      <div>
        <h1>Ceol Gan Eagla ‚Äî Weather & Marine</h1>
        <div class="sub">Sources: OSM ‚Ä¢ MapTiler ‚Ä¢ RainViewer ‚Ä¢ Open-Meteo ‚Ä¢ Nominatim ‚Ä¢ (optional) Tomorrow.io</div>
      </div>
    </div>

    <div class="card" id="searchWrap">
      <input id="search" placeholder="Search place or Eircode‚Ä¶"/>
      <div id="suggest"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnGeo" class="btn">üìç Me</button>
        <button id="btnPin"  class="btn ghost">üìå Pin</button>
        <label>Units
          <select id="units" class="btn ghost">
            <option value="metric" selected>Metric (¬∞C, m/s, mm)</option>
            <option value="imperial">Imperial (¬∞F, mph, in)</option>
          </select>
        </label>
        <label>Map
          <select id="mapStyle" class="btn ghost">
            <option value="streets" selected>Streets</option>
            <option value="satellite">Satellite</option>
            <option value="outdoor">Outdoor</option>
          </select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div id="nowIcon"></div>
        <div class="chip" id="temp">‚Äî</div>
        <div class="chip" id="wind">Wind ‚Äî</div>
        <div class="chip" id="precip">Precip ‚Äî</div>
        <div class="chip" id="cloud">Cloud ‚Äî</div>
        <div class="chip" id="sun">Sunrise ‚Äî / Sunset ‚Äî</div>
        <div class="chip" id="risk">‚Äî</div>
        <div class="chip" id="updated">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="play" class="btn ghost">‚ñ∂Ô∏é</button>
        <input id="frame" type="range" min="0" max="0" step="1" value="0"/>
        <span id="frametime" class="sub">‚Äî</span>
        <label style="margin-left:auto">Radar Opacity
          <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.7"/>
        </label>
        <button id="refresh" class="btn ghost">‚Üª</button>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Your GPS (boat) speed</div>
      <div class="row">
        <div class="chip" id="gps">‚è± 0 km/h</div>
        <button id="toggleSpeed" class="btn ghost">Units: km/h</button>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Next 24 hours</div>
      <div id="hourly">Loading‚Ä¶</div>
    </div>
    <div class="card">
      <div class="sub" style="margin-bottom:6px">7-day forecast</div>
      <div id="daily">Loading‚Ä¶</div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== CONFIG ===== */
const MAPTILER_KEY = 'MpDV384cXMNO273WsuTG'; // your key
const TOMORROW_API_KEY = ''; // OPTIONAL: put your Tomorrow.io API key here (leave empty to skip)

/* ===== MAP & BASE LAYERS ===== */
const map = L.map('map', { zoomControl:true }).setView([53.35,-6.26], 7);
const styles = {
  streets: `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
  satellite: `https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`,
  outdoor: `https://api.maptiler.com/maps/outdoor-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`
};
let base = L.tileLayer(styles.streets,{attribution:'&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler'}).addTo(map);
map.createPane('radar'); map.getPane('radar').style.zIndex = 450;
const radarLayer = L.tileLayer('', {pane:'radar', opacity:0.7}).addTo(map);

document.getElementById('mapStyle').addEventListener('change', e=>{
  const v=e.target.value;
  if (base) map.removeLayer(base);
  base=L.tileLayer(styles[v],{attribution:'&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler'}).addTo(map);
});

/* On-map badge */
const badge = document.getElementById('badge');

/* ===== UI ELEMENTS ===== */
const $ = id => document.getElementById(id);
const el = {
  units: $('units'), nowIcon:$('nowIcon'), temp:$('temp'), wind:$('wind'),
  precip:$('precip'), cloud:$('cloud'), sun:$('sun'), risk:$('risk'), updated:$('updated'),
  hourly:$('hourly'), daily:$('daily'), search:$('search'), suggest:$('suggest'),
  frame:$('frame'), play:$('play'), frametime:$('frametime'), opacity:$('opacity'),
  btnGeo:$('btnGeo'), btnPin:$('btnPin'), gps:$('gps'), toggleSpeed:$('toggleSpeed')
};

/* ===== HELPERS ===== */
let speedUnit='kmh'; let lastSpeedMs=0;
const toF      = c  => Math.round(c*9/5+32);
const msToMph  = ms => Math.round(ms*2.23694);
const msToKn   = ms => Math.round(ms*1.94384);
const mmToIn   = mm => Math.round(mm/25.4*100)/100;
const iconFor = code => '‚òÅ'; // simple placeholder; can swap to SVG set later
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function fmtSpeed(ms){
  if (ms==null||isNaN(ms)) ms=0;
  if (speedUnit==='kmh') return Math.round(ms*3.6)+' km/h';
  if (speedUnit==='mph') return Math.round(ms*2.23694)+' mph';
  return Math.round(ms*1.94384)+' kn';
}
function updateGPSUI(){ el.gps.textContent='‚è± '+fmtSpeed(lastSpeedMs); el.toggleSpeed.textContent='Units: '+(speedUnit==='kmh'?'km/h':speedUnit==='mph'?'mph':'knots'); }

/* ===== RADAR (RainViewer) ===== */
let RV={frames:[],idx:0,timer:null};
async function loadRadar(){
  try{
    const r=await fetch('https://api.rainviewer.com/public/weather-maps.json',{cache:'no-store'});
    const j=await r.json();
    RV.frames=(j.radar?.past||[]).concat(j.radar?.nowcast||[]);
    el.frame.max=Math.max(RV.frames.length-1,0);
    setRadar(RV.frames.length-1);
  }catch{}
}
function setRadar(i){
  RV.idx=Math.max(0,Math.min(i,RV.frames.length-1));
  const fr=RV.frames[RV.idx]; if(!fr) return;
  const url=`https://tilecache.rainviewer.com/v2/radar/${fr.time}/256/{z}/{x}/{y}/2/1_1.png`;
  radarLayer.setUrl(url);
  el.frametime.textContent=new Date(fr.time*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}
el.frame.oninput=e=>setRadar(+e.target.value);
el.play.onclick=()=>{ if(RV.timer){clearInterval(RV.timer);RV.timer=null;el.play.textContent='‚ñ∂Ô∏é';return;}
  el.play.textContent='‚è∏'; RV.timer=setInterval(()=>{const n=(RV.idx+1)%RV.frames.length; el.frame.value=n; setRadar(n);},700); };
el.opacity.oninput=e=>radarLayer.setOpacity(+e.target.value);
$('refresh').onclick=loadRadar;

/* ===== SEARCH / GEO ===== */
el.search.addEventListener('input', debounce(suggest,250));
el.search.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
el.btnGeo.onclick=()=>navigator.geolocation?.getCurrentPosition(p=>{const {latitude:lat,longitude:lon}=p.coords; map.setView([lat,lon],10); L.marker([lat,lon]).addTo(map).bindPopup('You are here').openPopup(); updateAll(lat,lon,'My location');});
el.btnPin.onclick=()=>{const c=map.getCenter();L.marker([c.lat,c.lng]).addTo(map);updateAll(c.lat,c.lng,'Pinned point');};

async function suggest(){
  const q=el.search.value.trim(); if(!q){el.suggest.style.display='none';return;}
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=6&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':'en'}});
  const arr=await r.json();
  el.suggest.innerHTML=arr.map(o=>`<div class="item" data-lat="${o.lat}" data-lon="${o.lon}">${o.display_name}</div>`).join('');
  el.suggest.style.display=arr.length?'block':'none';
}
el.suggest.onclick=e=>{
  const it=e.target.closest('.item'); if(!it) return;
  const lat=+it.dataset.lat, lon=+it.dataset.lon; const name=it.textContent;
  el.suggest.style.display='none'; map.setView([lat,lon],10); L.marker([lat,lon]).addTo(map).bindPopup(name).openPopup(); updateAll(lat,lon,name);
};
async function doSearch(){
  const q=el.search.value.trim(); if(!q) return;
  const eir=/^[A-Z0-9]{3}\s?[A-Z0-9]{4}$/i;
  const url=eir.test(q)?`https://nominatim.openstreetmap.org/search?postalcode=${q.replace(/\s+/g,'')}&countrycodes=ie&format=json&addressdetails=1&limit=5`
    :`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`;
  const r=await fetch(url,{headers:{'Accept-Language':navigator.language||'en'}}); const j=await r.json(); if(!j.length) return;
  const {lat,lon,display_name}=j[0]; map.setView([+lat,+lon],10); L.marker([+lat,+lon]).addTo(map).bindPopup(display_name).openPopup(); updateAll(+lat,+lon,display_name);
}

/* ===== WEATHER (Open-Meteo) + optional Tomorrow.io ===== */
async function updateAll(lat,lon,label=''){
  badge.textContent = `${label||'Here'} ‚Ä¢ ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  await Promise.all([updateForecast(lat,lon), updateTomorrow(lat,lon)]); // Tomorrow only runs if key is set
}
el.units.onchange=()=>{ const c=map.getCenter(); updateAll(c.lat,c.lng,'Updated units'); };

async function updateForecast(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      +`&current_weather=true`
      +`&hourly=temperature_2m,precipitation,cloudcover,windspeed_10m,weathercode,snowfall`
      +`&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset`
      +`&forecast_days=7&timezone=auto`;
    const r=await fetch(url,{cache:'no-store'}); const j=await r.json();

    const metric=el.units.value==='metric';
    const cNow=j.current_weather;
    const tC=Math.round(cNow?.temperature??0);
    const wMs=j.hourly?.windspeed_10m?.[0]??0;
    const pMm=j.hourly?.precipitation?.[0]??0;
    const cl=j.hourly?.cloudcover?.[0]??0;
    const snow=j.hourly?.snowfall?.[0]??0;
    const sunrise=j.daily.sunrise?.[0], sunset=j.daily.sunset?.[0];

    el.nowIcon.textContent=iconFor(cNow?.weathercode??0);
    el.temp.textContent  = metric?`${tC}¬∞C`:`${toF(tC)}¬∞F`;
    el.wind.textContent  = metric?`Wind ${Math.round(wMs)} m/s`:`Wind ${msToMph(wMs)} mph`;
    el.precip.textContent= metric?`Precip ${pMm} mm`:`Precip ${mmToIn(pMm)} in`;
    el.cloud.textContent = `Cloud ${cl}%`;
    el.sun.textContent   = `Sunrise ${new Date(sunrise).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} / Sunset ${new Date(sunset).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;
    el.risk.textContent  = (snow>0?'‚ùÑ snow':'') + ((cl<=0 && pMm>0)?' ‚Ä¢ üåß rain':'') + (snow>0?' ‚Ä¢ üßä ice risk':'');
    el.updated.textContent = `Updated ${new Date().toLocaleTimeString()}`;

    // 24h
    el.hourly.innerHTML='';
    for(let i=0;i<24;i++){
      const ti=j.hourly.time[i].slice(11,16);
      const tc=j.hourly.temperature_2m[i];
      const pp=j.hourly.precipitation[i];
      const card=document.createElement('div'); card.className='hour';
      card.innerHTML=`${ti}<div class="ico">${iconFor(j.hourly.weathercode[i])}</div>`
        +`${metric?Math.round(tc)+'¬∞C':toF(tc)+'¬∞F'}<br>${metric?pp+' mm':mmToIn(pp)+' in'}`;
      el.hourly.appendChild(card);
    }
    // 7-day
    el.daily.innerHTML='';
    for(let i=0;i<7;i++){
      const wd=new Date(j.daily.time[i]).toLocaleDateString(undefined,{weekday:'short'});
      const tmax=j.daily.temperature_2m_max[i], tmin=j.daily.temperature_2m_min[i];
      const pr=j.daily.precipitation_sum?.[i]??0;
      const d=document.createElement('div'); d.className='day';
      d.innerHTML=`${wd}<div class="ico">${iconFor(0)}</div>`
        +`${metric?Math.round(tmax)+'¬∞C / '+Math.round(tmin)+'¬∞C':toF(tmax)+'¬∞F / '+toF(tmin)+'¬∞F'}<br>`
        +`${metric?pr+' mm':mmToIn(pr)+' in'}`;
      el.daily.appendChild(d);
    }
  }catch(e){ el.updated.textContent='Live forecast failed'; }
}

/* OPTIONAL: Tomorrow.io for extra wind detail (requires key) */
async function updateTomorrow(lat,lon){
  if(!TOMORROW_API_KEY) return; // skip if no key
  try{
    const url=`https://api.tomorrow.io/v4/weather/realtime?location=${lat},${lon}&units=metric&apikey=${TOMORROW_API_KEY}`;
    const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
    const ws=j?.data?.values?.windSpeed??null;
    if(ws!=null){
      const metric=el.units.value==='metric';
      const text=metric?`Wind ${Math.round(ws)} m/s (Tomorrow.io)`:`Wind ${msToMph(ws)} mph (Tomorrow.io)`;
      el.wind.textContent=text; // prefer Tomorrow.io if present
    }
  }catch(e){ /* ignore if fails */ }
}

/* ===== GPS (boat) speed ===== */
function startGPS(){
  if(!('geolocation' in navigator)) { el.gps.textContent='‚è± GPS not supported'; return; }
  navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat,longitude:lon,speed}=pos.coords;
      lastSpeedMs=(speed==null)?0:speed;
      updateGPSUI();
      badge.textContent=`${lat.toFixed(3)}, ${lon.toFixed(3)} ‚Ä¢ ${fmtSpeed(lastSpeedMs)}`;
    },
    err=>{ el.gps.textContent='‚è± GPS unavailable'; console.error(err); },
    { enableHighAccuracy:true, maximumAge:5000, timeout:20000 }
  );
}
el.toggleSpeed.onclick=()=>{ speedUnit = speedUnit==='kmh' ? 'mph' : speedUnit==='mph' ? 'kn' : 'kmh'; updateGPSUI(); };

/* ===== INIT ===== */
loadRadar();
setInterval(loadRadar, 5*60*1000);
startGPS();
navigator.geolocation?.getCurrentPosition(
  p=>{ const {latitude:lat,longitude:lon}=p.coords; map.setView([lat,lon],10); updateAll(lat,lon,'My location'); },
  ()=>{ updateAll(53.35,-6.26,'Dublin area'); }
);
</script>
</body>
</html>      text-align: center;
      border-top: 1px solid #333;
      z-index: 10000;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #gps-bar button {
      background: #ffffff;
      color: #111;
      border: 0;
      padding: 5px 10px;
      margin-left: 8px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    #gps-bar .sep {
      opacity: .5; padding: 0 6px;
    }

    /* Move zoom to bottom-right so it never overlaps custom overlays */
    .leaflet-bottom.leaflet-right .leaflet-control-zoom {
      margin: 10px;
    }

    /* Optional: a small ‚Äúbadge‚Äù on the map top-left that shows the last fix */
    .map-badge {
      position: absolute;
      left: 10px; top: 10px;
      background: rgba(18,18,22,.9);
      border: 1px solid rgba(255,255,255,.2);
      color: #fff;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      z-index: 500;
      pointer-events: none; /* never blocks clicks */
    }
  </style>
</head>
<body>

  <!-- Map container -->
  <div id="map">
    <div id="badge" class="map-badge">Locating‚Ä¶</div>
  </div>

  <!-- Bottom bar for GPS info -->
  <div id="gps-bar">
    <span id="gps-location">üìç Locating‚Ä¶</span>
    <span class="sep">|</span>
    <span id="gps-speed">‚è±Ô∏è Speed: 0 km/h</span>
    <button id="unit-btn" type="button" onclick="toggleUnits()">Toggle Units (km/h)</button>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ===== CONFIG =====
    const MAPTILER_KEY = "MpDV384cXMNO273WsuTG"; // your key

    // ===== MAP INIT =====
    const map = L.map('map', {
      zoomControl: false  // remove default position‚Ä¶
    }).setView([53.35, -6.26], 8);

    // add zoom bottom-right
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // tiles
    const mapTiler = L.tileLayer(
      `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      { attribution: '&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler' }
    );

    // fallback to OSM if MapTiler fails (e.g., key blocked)
    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; OpenStreetMap contributors' }
    );

    mapTiler.on('tileerror', () => {
      if (!map.hasLayer(osm)) {
        osm.addTo(map);
      }
    });

    mapTiler.addTo(map);

    // ===== GPS + SPEED =====
    let speedUnit = "kmh";   // "kmh" | "mph" | "knots"
    let lastSpeedMs = 0;     // last speed in m/s for instant re-render
    let gotFix = false;

    const locEl  = document.getElementById("gps-location");
    const spdEl  = document.getElementById("gps-speed");
    const unitBtn = document.getElementById("unit-btn");
    const badge  = document.getElementById("badge");

    function convertSpeed(ms) {
      if (ms == null || isNaN(ms)) ms = 0;
      if (speedUnit === "kmh")   return (ms * 3.6).toFixed(1) + " km/h";
      if (speedUnit === "mph")   return (ms * 2.23694).toFixed(1) + " mph";
      /* knots */                return (ms * 1.94384).toFixed(1) + " knots";
    }

    function updateSpeedDisplay() {
      spdEl.textContent = "‚è±Ô∏è Speed: " + convertSpeed(lastSpeedMs);
      unitBtn.textContent = "Toggle Units (" + (speedUnit === "kmh" ? "km/h" : speedUnit) + ")";
    }

    function toggleUnits() {
      speedUnit = (speedUnit === "kmh") ? "mph" : (speedUnit === "mph") ? "knots" : "kmh";
      updateSpeedDisplay();
    }

    function setBadge(lat, lon, extra = "") {
      badge.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}${extra ? " ‚Äî " + extra : ""}`;
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        pos => {
          const { latitude: lat, longitude: lon, speed } = pos.coords;
          lastSpeedMs = (speed == null) ? 0 : speed;

          // update UI
          locEl.textContent = `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
          updateSpeedDisplay();
          setBadge(lat, lon, convertSpeed(lastSpeedMs));

          // place/refresh marker only on first fix (avoid map jumping)
          if (!gotFix) {
            gotFix = true;
            map.setView([lat, lon], 14);
            L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
          }
        },
        err => {
          locEl.textContent = "üìç Location unavailable";
          console.error("Geolocation error:", err);
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
      );
    } else {
      locEl.textContent = "üìç Geolocation not supported";
    }

    // ensure map resizes correctly if soft keyboard changes viewport height
    window.addEventListener('resize', () => {
      map.invalidateSize();
    });
  </script>
</body>
</html>  // --- MAP INIT (Leaflet + MapTiler) ---
  const MAPTILER_KEY = "MpDV384cXMNO273WsuTG"; // your key
  const map = L.map('map').setView([53.35, -6.26], 8);
  L.tileLayer(
    `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
    { attribution: '&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler' }
  ).addTo(map);

  // --- GPS & SPEED ---
  let speedUnit = "kmh";            // "kmh" | "mph" | "knots"
  let lastSpeedMs = 0;              // store last m/s so toggling units can update immediately
  const locEl = document.getElementById("gps-location");
  const spdEl = document.getElementById("gps-speed");
  const unitBtn = document.getElementById("unit-btn");

  function convertSpeed(ms) {
    if (ms == null || isNaN(ms)) ms = 0;
    if (speedUnit === "kmh")   return (ms * 3.6).toFixed(1) + " km/h";
    if (speedUnit === "mph")   return (ms * 2.23694).toFixed(1) + " mph";
    /* knots */                return (ms * 1.94384).toFixed(1) + " knots";
  }

  function updateSpeedDisplay() {
    spdEl.textContent = "‚è±Ô∏è Speed: " + convertSpeed(lastSpeedMs);
    unitBtn.textContent = "Toggle Units (" + (speedUnit === "kmh" ? "km/h" : speedUnit) + ")";
  }

  function toggleUnits() {
    speedUnit = speedUnit === "kmh" ? "mph" : speedUnit === "mph" ? "knots" : "kmh";
    updateSpeedDisplay();
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        lastSpeedMs = (pos.coords.speed == null) ? 0 : pos.coords.speed; // m/s

        // Update UI
        locEl.textContent = `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        updateSpeedDisplay();

        // Optionally center map the first time we get a fix (comment out to avoid constant jumps)
        if (!map._gotFix) {
          map.setView([lat, lon], 13);
          map._gotFix = true;
          L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
        }
      },
      err => {
        locEl.textContent = "üìç Location unavailable";
        console.error(err);
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
    );
  } else {
    locEl.textContent = "üìç Geolocation not supported";
  }
</script>
<script>
  let speedUnit = "kmh"; // default

  function toggleUnits() {
    if (speedUnit === "kmh") speedUnit = "mph";
    else if (speedUnit === "mph") speedUnit = "knots";
    else speedUnit = "kmh";
  }

  function convertSpeed(ms) {
    if (speedUnit === "kmh") return (ms * 3.6).toFixed(1) + " km/h";
    if (speedUnit === "mph") return (ms * 2.23694).toFixed(1) + " mph";
    if (speedUnit === "knots") return (ms * 1.94384).toFixed(1) + " knots";
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude.toFixed(5);
        const lon = pos.coords.longitude.toFixed(5);
        document.getElementById("gps-location").textContent = `üìç ${lat}, ${lon}`;

        const speed = pos.coords.speed; // in m/s
        document.getElementById("gps-speed").textContent = 
          "‚è±Ô∏è Speed: " + (speed ? convertSpeed(speed) : "0");
      },
      err => {
        document.getElementById("gps-location").textContent = "üìç Location unavailable";
        console.error(err);
      },
      { enableHighAccuracy: true }
    );
  } else {
    document.getElementById("gps-location").textContent = "üìç Geolocation not supported";
  }
</script>
