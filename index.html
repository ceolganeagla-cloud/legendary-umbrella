<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Ceol Gan Eagla — Marine</title>
<meta name="theme-color" content="#0a0f15">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
  :root{
    --bg:#09131b; --ink:#eaf2ff; --muted:#a8bed6; --panel:#0d1620;
    --card:#0f1c28; --line:#1b2a3a; --accent:#20d27d; --warn:#ef4444; --gold:#ffcf63;
  }
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;overflow:hidden}

  header{position:fixed;inset:0 0 auto 0;z-index:30;display:flex;gap:.6rem;align-items:center;
    padding:8px 12px;background:linear-gradient(180deg,rgba(9,19,27,.85),rgba(9,19,27,.35) 70%,transparent);
    border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)}
  .logo{width:30px;height:30px;border-radius:9px;display:grid;place-items:center;
    background:linear-gradient(135deg,#135b2a,#0e3c1c);border:1px solid rgba(255,255,255,.12)}
  .logo:before{content:"♪";color:var(--gold);font-weight:800}
  h1{font-size:15px;margin:0;line-height:1.1}
  .sub{font-size:11px;color:var(--muted);margin-top:2px}
  .brand{margin-left:auto;font-size:11px;color:var(--muted);font-weight:700}

  #map{position:fixed;inset:52px 0 120px 0}
  .leaflet-top.leaflet-left{top:62px} /* nudge zoom */
  .leaflet-control-attribution{margin-bottom:6px}

  /* Bottom panel */
  .panel{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,#0c1721,#0a131c);
    border-top:1px solid var(--line);padding:8px 10px 12px;z-index:25;transition:transform .2s ease}
  .panel.hidden{transform:translateY(92%)} /* slide down when hidden */
  .togrow{display:flex;gap:8px;justify-content:center;margin-bottom:6px}
  .btn{appearance:none;border:none;cursor:pointer;background:#112233;color:var(--ink);
    padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.09);font-weight:700}
  .btn.min{padding:8px 10px;font-size:13px}
  .btn.primary{background:linear-gradient(180deg,#1b6b43,#0e3a23)}
  .btn.ghost{background:transparent;border-style:dashed}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .card{background:linear-gradient(180deg,#0f1d2a,#0c1823);border:1px solid var(--line);
    border-radius:12px;padding:8px 10px}
  .card h3{margin:0 0 6px;font-size:11px;color:var(--muted);letter-spacing:.2px}
  .kv{display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
  .big{font-size:20px;font-weight:800}
  .unit{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cfe}

  @media (max-width:640px){ .cards{grid-template-columns:1fr} #map{bottom:132px} }
</style>
</head>
<body>
<header>
  <div class="logo" aria-label="Ceol Gan Eagla"></div>
  <div>
    <h1>Ceol Gan Eagla — Marine</h1>
    <div class="sub">Seamarks • Live Wind • Sun & Moon</div>
  </div>
  <div class="brand">CGE</div>
</header>

<div id="map" aria-label="Marine map"></div>

<section class="panel" id="panel">
  <div class="togrow">
    <button id="follow" class="btn primary min"><span id="gpsdot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:6px"></span>Follow</button>
    <button id="trail" class="btn min">Trail: On</button>
    <button id="recenter" class="btn ghost min">Re-center</button>
    <button id="fullscreen" class="btn ghost min">Full-screen</button>
    <button id="toggleInfo" class="btn min">Hide Info</button>
  </div>

  <div class="cards">
    <div class="card">
      <h3>Boat</h3>
      <div class="kv">
        <div class="big"><span id="spd">—</span><span class="unit"> kn</span></div>
        <div class="unit">(<span id="spdkmh">—</span> km/h)</div>
        <div class="unit">HDG <span id="hdg">—</span>°</div>
        <div class="unit">ACC <span id="acc">—</span> m</div>
      </div>
    </div>
    <div class="card">
      <h3>Position</h3>
      <div class="kv mono">Lat <span id="lat">—</span> • Lon <span id="lon">—</span></div>
      <div class="kv mono">Last fix: <span id="fixage">—</span>s ago</div>
    </div>
    <div class="card">
      <h3>Weather (Open-Meteo)</h3>
      <div class="kv">
        <div class="big"><span id="wind">—</span><span class="unit"> m/s</span></div>
        <div class="unit">Gust <span id="gust">—</span></div>
        <div class="unit">Dir <span id="wdir">—</span>°</div>
      </div>
      <div class="kv">
        <div class="unit">Wave H <span id="wave">—</span> m</div>
        <div class="unit">Temp <span id="temp">—</span>°C</div>
        <div class="unit">MSLP <span id="mslp">—</span> hPa</div>
      </div>
    </div>
    <div class="card">
      <h3>Sun & Moon</h3>
      <div class="kv">
        <div class="unit">Sunrise <span id="sunup">—</span></div>
        <div class="unit">Sunset <span id="sundown">—</span></div>
        <div class="unit">Moon <span id="moon">—</span>%</div>
      </div>
    </div>
  </div>
</section>

<script>
/* Map */
const map = L.map('map', { zoomControl:true, worldCopyJump:true, tap:false }).setView([53.35,-6.26], 12);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
const seamarks = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png',{maxZoom:18,opacity:.9,attribution:'&copy; OpenSeaMap'}).addTo(map);
L.control.layers({OSM:osm},{Seamarks:seamarks},{collapsed:true,position:'topleft'}).addTo(map);

/* UI */
const $ = s => document.querySelector(s);
const panel = $('#panel');
$('#toggleInfo').onclick = () => {
  panel.classList.toggle('hidden');
  $('#toggleInfo').textContent = panel.classList.contains('hidden') ? 'Show Info' : 'Hide Info';
};
$('#fullscreen').onclick = () => {
  const el = document.documentElement;
  if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
};

/* Boat marker, trail, heading cone */
const boatIcon = L.divIcon({className:'boat',html:`<div style="width:18px;height:18px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #20d27d 0%, #15784b 60%, #0c3a25 100%);
  border:2px solid rgba(255,255,255,.7);box-shadow:0 0 10px rgba(32,210,125,.55)"></div>` ,iconSize:[18,18],iconAnchor:[9,9]});
let boat = L.marker([53.35,-6.26],{icon:boatIcon}).addTo(map);
let trailOn = true; const trail = L.polyline([], {color:'#22c55e',weight:3,opacity:.85}).addTo(map);
const cone = L.polygon([], {color:'#22c55e',weight:1,opacity:.6,fillOpacity:.08}).addTo(map);
$('#trail').onclick = () => { trailOn = !trailOn; $('#trail').textContent = `Trail: ${trailOn?'On':'Off'}`; if(!trailOn) trail.setLatLngs([]); };

/* Buttons */
const followBtn = $('#follow'), gpsdot = $('#gpsdot'), recenterBtn = $('#recenter');
let follow=false, watchId=null, lastFix=null;
followBtn.onclick = () => {
  follow = !follow;
  followBtn.classList.toggle('primary', follow);
  gpsdot.style.background = follow ? '#20d27d' : '#ef4444';
  follow ? startWatch() : (navigator.geolocation.clearWatch?.(watchId), watchId=null);
};
recenterBtn.onclick = () => { if(lastFix) map.setView([lastFix.coords.latitude,lastFix.coords.longitude], Math.max(14,map.getZoom())) };

/* Geo */
function startWatch(){
  if(!('geolocation' in navigator)) return;
  if(watchId) return;
  watchId = navigator.geolocation.watchPosition(onPos, err => {gpsdot.style.background='#ef4444'}, {enableHighAccuracy:true,maximumAge:1000,timeout:10000});
}

const spd=$('#spd'), spdkmh=$('#spdkmh'), hdg=$('#hdg'), acc=$('#acc'), latEl=$('#lat'), lonEl=$('#lon'), fixage=$('#fixage');

function onPos(pos){
  lastFix = pos;
  const {latitude:lat, longitude:lon, accuracy, heading, speed} = pos.coords;
  const now=Date.now();
  latEl.textContent = lat.toFixed(5);
  lonEl.textContent = lon.toFixed(5);
  acc.textContent = (accuracy??0).toFixed(0);
  fixage.textContent = ((now - pos.timestamp)/1000|0);

  // speed m/s -> knots / kmh; fallback estimate
  let ms = (typeof speed==='number' && speed>=0) ? speed : NaN;
  if(!Number.isFinite(ms) && onPos._last){
    const dt = (now - onPos._last.t)/1000;
    if(dt>0.2){
      const d = map.distance([lat,lon], onPos._last.ll);
      ms = d/dt;
    }
  }
  onPos._last = {t:now,ll:[lat,lon]};

  const kn = Number.isFinite(ms) ? ms*1.94384 : NaN;
  const kmh = Number.isFinite(ms) ? ms*3.6 : NaN;
  spd.textContent = Number.isFinite(kn)?kn.toFixed(1):'—';
  spdkmh.textContent = Number.isFinite(kmh)?kmh.toFixed(1):'—';

  const hd = (typeof heading==='number' && heading>=0)?heading:estimateHeading();
  hdg.textContent = Number.isFinite(hd)?Math.round(hd):'—';

  boat.setLatLng([lat,lon]);
  drawCone([lat,lon], Number.isFinite(hd)?hd:null);

  if(follow) map.setView([lat,lon], Math.max(14,map.getZoom()), {animate:true});

  if(trailOn){
    const pts = trail.getLatLngs(); const last = pts[pts.length-1];
    if(!last || map.distance(last,[lat,lon])>2){ pts.push([lat,lon]); trail.setLatLngs(pts); }
  }

  refreshWeather(lat,lon);
  refreshSunMoon(lat,lon);
}

function estimateHeading(){
  const pts = trail.getLatLngs(); if(pts.length<2) return NaN;
  const a=pts[pts.length-2], b=pts[pts.length-1];
  const y=Math.sin((b.lng-a.lng)*Math.PI/180)*Math.cos(b.lat*Math.PI/180);
  const x=Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180)-Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos((b.lng-a.lng)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function drawCone([lat,lon], bearing){
  if(!Number.isFinite(bearing)){cone.setLatLngs([]);return;}
  const range=120, spread=30;
  const p1 = dest(lat,lon,bearing-spread,range);
  const p2 = dest(lat,lon,bearing+spread,range);
  cone.setLatLngs([[lat,lon], p1, p2]);
}
function dest(lat,lon,brng,dist){
  const R=6371000, br=brng*Math.PI/180, φ1=lat*Math.PI/180, λ1=lon*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(br));
  const λ2=λ1+Math.atan2(Math.sin(br)*Math.sin(δ)*Math.cos(φ1),Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return [φ2*180/Math.PI, ((λ2*180/Math.PI)+540)%360-180];
}

/* Weather (Open-Meteo hourly, nearest hour) */
let lastWX={t:0, ll:null};
async function refreshWeather(lat,lon){
  const now=Date.now();
  if(now-lastWX.t<90000 && lastWX.ll && map.distance(lastWX.ll,[lat,lon])<2000) return;
  lastWX={t:now,ll:[lat,lon]};

  try{
    const url=new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude', lat);
    url.searchParams.set('longitude', lon);
    url.searchParams.set('hourly','wind_speed_10m,wind_gusts_10m,wind_direction_10m,temperature_2m,surface_pressure,wave_height');
    url.searchParams.set('timezone','auto');
    url.searchParams.set('forecast_days','1');
    const r=await fetch(url, {cache:'no-store'}); const j=await r.json();
    const H=j.hourly; if(!H){return;}

    // pick nearest hour index
    const idx = nearestHourIndex(H.time);
    set('#wind', H.wind_speed_10m?.[idx]);
    set('#gust', H.wind_gusts_10m?.[idx]);
    set('#wdir', H.wind_direction_10m?.[idx]);
    set('#temp', H.temperature_2m?.[idx]);
    set('#mslp', H.surface_pressure?.[idx]);
    set('#wave', H.wave_height?.[idx]); // may be undefined in some locations
  }catch(e){/* silent fallback */}
}
function nearestHourIndex(times){
  const now = new Date();
  let best=0, bestd=1e15;
  for(let i=0;i<times.length;i++){
    const d=Math.abs(new Date(times[i]).getTime()-now.getTime());
    if(d<bestd){bestd=d;best=i;}
  }
  return best;
}
function set(sel,val){ const el=$(sel); el.textContent=(val==null||isNaN(+val))?'—':(+val).toFixed(1); }

/* Sun & Moon */
let sunKey='';
function refreshSunMoon(lat,lon){
  const k = `${lat.toFixed(2)},${lon.toFixed(2)}:${new Date().toDateString()}`;
  if(k===sunKey) return; sunKey=k;
  const now=new Date(), t=SunCalc.getTimes(now,lat,lon), m=SunCalc.getMoonIllumination(now);
  $('#sunup').textContent = hm(t.sunrise); $('#sundown').textContent = hm(t.sunset); $('#moon').textContent = Math.round(m.fraction*100);
}
function hm(d){ if(!d) return '—'; return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }

/* Auto-start if already granted */
if(navigator.permissions && navigator.permissions.query){
  navigator.permissions.query({name:'geolocation'}).then(p=>{ if(p.state==='granted'){ follow=true; followBtn.click(); } }).catch(()=>{});
}
</script>
</body>
</html>
