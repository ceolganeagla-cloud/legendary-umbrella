<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ceol Gan Eagla â€” Weather</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0b1220"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#0b1220;--panel:#12141c;--card:#1a1e29;--text:#eaeaea;--muted:#b9b9c2;--accent:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:1fr 420px;gap:12px;height:100vh;padding:12px}
#map{width:100%;height:100%;border-radius:16px;overflow:hidden;position:relative}
aside{background:var(--panel);border-radius:16px;overflow:auto;padding:12px}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.logo{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#000;flex:0 0 48px}
.logo img{width:100%;height:100%;object-fit:contain;background:#fff}
h1{font-size:18px;margin:0}.sub{color:var(--muted);font-size:12px}

.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:0;padding:8px 10px;border-radius:10px;background:var(--accent);color:#111;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
select, input[type=text]{background:#0f131c;color:var(--text);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px}
input[type=range]{width:180px}

#hourly{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px}
.hour{min-width:96px;padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.hour .ico{font-size:22px;margin:4px 0}

#daily{display:grid;grid-template-columns:repeat(7,minmax(96px,1fr));gap:8px}
.day{padding:8px;border-radius:10px;background:rgba(255,255,255,.06);text-align:center}
.day .ico{font-size:22px;margin:4px 0}

#searchWrap{position:relative}
#suggest{position:absolute;left:0;right:0;top:44px;background:#0f131c;border:1px solid rgba(255,255,255,.15);border-radius:10px;overflow:hidden;display:none;max-height:240px;overflow:auto;z-index:20}
.item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer}
.item:hover{background:rgba(255,255,255,.06)}

.chip{padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.06);font-size:12px}

.map-badge{position:absolute;left:10px;top:10px;background:rgba(18,18,22,.88);color:#fff;
  border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:8px;font-size:12px;z-index:450}

.leaflet-popup { margin-top: 30px !important; }

@media (max-width:860px){.app{grid-template-columns:1fr;grid-template-rows:50vh 1fr}}
</style>
</head>
<body>
<div class="app">
  <div id="map"></div>

  <aside>
    <div class="brand">
      <div class="logo">
        <img src="icon-192.png" alt="Ceol Gan Eagla Logo">
      </div>
      <div>
        <h1>Ceol Gan Eagla â€” Weather</h1>
        <div class="sub">Sources: OSM â€¢ MapTiler â€¢ RainViewer â€¢ Open-Meteo â€¢ Nominatim</div>
      </div>
    </div>

    <div class="card" id="searchWrap">
      <input id="search" placeholder="Search place or Eircodeâ€¦"/>
      <div id="suggest"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnGeo" class="btn">ğŸ“ Me</button>
        <button id="btnPin"  class="btn ghost">ğŸ“Œ Pin</button>
        <label>Units
          <select id="units" class="btn ghost">
            <option value="metric" selected>Metric (Â°C)</option>
            <option value="imperial">Imperial (Â°F)</option>
          </select>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div id="nowIcon"></div>
        <div class="chip" id="temp">â€”</div>
        <div class="chip" id="wind">Wind â€”</div>
        <div class="chip" id="precip">Precip â€”</div>
        <div class="chip" id="cloud">Cloud â€”</div>
        <div class="chip" id="sun">Sunrise â€” / Sunset â€”</div>
        <div class="chip" id="risk">â€”</div>
        <div class="chip" id="updated">â€”</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="play" class="btn ghost">â–¶ï¸</button>
        <input id="frame" type="range" min="0" max="0" step="1" value="0"/>
        <span id="frametime" class="sub">â€”</span>
        <label style="margin-left:auto">Opacity <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.7"/></label>
        <button id="refresh" class="btn ghost">â†»</button>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Next 24 hours</div>
      <div id="hourly">Loadingâ€¦</div>
    </div>
    <div class="card">
      <div class="sub" style="margin-bottom:6px">7-day forecast</div>
      <div id="daily">Loadingâ€¦</div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== CONFIG ===== */
const MAPTILER_KEY = 'MpDV384cXMNO273WsuTG';

/* ===== ICONS ===== */
function wIcon(code) {
  const map = {
    0: "â˜€ï¸", 1: "ğŸŒ¤ï¸", 2: "â›…", 3: "â˜ï¸",
    45: "ğŸŒ«ï¸", 48: "ğŸŒ«ï¸",
    51: "ğŸŒ¦ï¸", 61: "ğŸŒ§ï¸", 63: "ğŸŒ§ï¸", 65: "ğŸŒ§ï¸",
    66: "ğŸŒ§ï¸", 67: "ğŸŒ§ï¸",
    71: "â„ï¸", 73: "â„ï¸", 75: "â„ï¸", 77: "â„ï¸",
    80: "ğŸŒ§ï¸", 81: "ğŸŒ§ï¸", 82: "ğŸŒ§ï¸",
    95: "â›ˆï¸", 96: "â›ˆï¸", 99: "â›ˆï¸"
  };
  return `<div class="ico">${map[code] || "â”"}</div>`;
}

/* ===== MAP ===== */
const map = L.map('map', { zoomControl: true }).setView([53.35,-6.26], 7);
L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`, {
  attribution: '&copy; OpenStreetMap â€¢ &copy; MapTiler'
}).addTo(map);

map.createPane('radar'); map.getPane('radar').style.zIndex = 450;
const radar = L.tileLayer('', {pane:'radar', opacity:0.7}).addTo(map);

const $ = id => document.getElementById(id);
const el = {
  units: $('units'), frame: $('frame'), play: $('play'), frametime: $('frametime'), opacity: $('opacity'),
  updated: $('updated'), temp: $('temp'), wind: $('wind'), precip: $('precip'), cloud: $('cloud'),
  sun: $('sun'), risk: $('risk'), nowIcon: $('nowIcon'),
  hourly: $('hourly'), daily: $('daily'), search: $('search'), suggest: $('suggest')
};
const toF = c => Math.round(c*9/5+32);
const msToMph = ms => Math.round(ms*2.23694);
const mmToIn = mm => Math.round(mm/25.4*100)/100;

/* ===== RADAR ===== */
let RV = { frames: [], index: 0, timer: null };
async function loadRadar() {
  const r = await fetch('https://api.rainviewer.com/public/weather-maps.json',{cache:'no-store'});
  const j = await r.json();
  RV.frames = (j.radar?.past||[]).concat(j.radar?.nowcast||[]);
  el.frame.max = Math.max(RV.frames.length-1,0);
  setRadar(RV.frames.length-1);
}
function setRadar(i) {
  RV.index=Math.max(0,Math.min(i,RV.frames.length-1));
  const fr=RV.frames[RV.index]; if(!fr) return;
  radar.setUrl(`https://tilecache.rainviewer.com/v2/radar/${fr.time}/256/{z}/{x}/{y}/2/1_1.png`);
  el.frametime.textContent=new Date(fr.time*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
el.frame.oninput=e=>setRadar(+e.target.value);
el.play.onclick=()=>{
  if(RV.timer){clearInterval(RV.timer);RV.timer=null;el.play.textContent='â–¶ï¸';return;}
  el.play.textContent='â¸';
  RV.timer=setInterval(()=>{const n=(RV.index+1)%RV.frames.length;el.frame.value=n;setRadar(n);},700);
};
el.opacity.oninput=e=>radar.setOpacity(+e.target.value);
$('refresh').onclick=loadRadar;

/* ===== WEATHER ===== */
async function updateWeather(lat,lon,label='') {
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
   +`&current_weather=true&hourly=temperature_2m,precipitation,cloudcover,windspeed_10m,weathercode,snowfall`
   +`&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset&forecast_days=7&timezone=auto`;
  const r=await fetch(url); const j=await r.json();

  const metric=el.units.value==='metric';
  const tC=Math.round(j.current_weather?.temperature??0);
  const wind=j.hourly?.windspeed_10m?.[0]??0;
  const p=j.hourly?.precipitation?.[0]??0;
  const cl=j.hourly?.cloudcover?.[0]??0;
  const snow=j.hourly?.snowfall?.[0]??0;
  const sunrise=j.daily.sunrise?.[0], sunset=j.daily.sunset?.[0];

  el.nowIcon.innerHTML=wIcon(j.current_weather?.weathercode??0);
  el.temp.textContent=metric?`${tC}Â°C`:`${toF(tC)}Â°F`;
  el.wind.textContent=metric?`Wind ${Math.round(wind)} m/s`:`Wind ${msToMph(wind)} mph`;
  el.precip.textContent=metric?`Precip ${p} mm`:`Precip ${mmToIn(p)} in`;
  el.cloud.textContent=`Cloud ${cl}%`;
  el.sun.textContent=`Sunrise ${new Date(sunrise).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} / Sunset ${new Date(sunset).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
  el.risk.textContent=(snow>0?'â„ snow':'')+((cl<=0&&p>0)?' â€¢ ğŸŒ§ rain':'')+(snow>0?' â€¢ ğŸ§Š ice':'');
  el.updated.textContent=`Updated ${new Date().toLocaleTimeString()}`;

  el.hourly.innerHTML='';
  for(let i=0;i<24;i++){
    const ti=j.hourly.time[i].slice(11,16);
    const tc=j.hourly.temperature_2m[i];
    const pp=j.hourly.precipitation[i];
    const div=document.createElement('div');div.className='hour';
    div.innerHTML=`${ti}${wIcon(j.hourly.weathercode[i])}`
      +`${metric?Math.round(tc)+'Â°C':toF(tc)+'Â°F'}<br>${metric?pp+' mm':mmToIn(pp)+' in'}`;
    el.hourly.appendChild(div);
  }
  el.daily.innerHTML='';
  for(let i=0;i<7;i++){
    const wd=new Date(j.daily.time[i]).toLocaleDateString(undefined,{weekday:'short'});
    const tmax=j.daily.temperature_2m_max[i], tmin=j.daily.temperature_2m_min[i];
    const div=document.createElement('div');div.className='day';
    div.innerHTML=`${wd}${wIcon(j.daily.weathercode?.[i]??0)}`
      +`${metric?Math.round(tmax)+'Â°C / '+Math.round(tmin)+'Â°C':toF(tmax)+'Â°F / '+toF(tmin)+'Â°F'}<br>`
      +`${metric?(j.daily.precipitation_sum?.[i]??0)+' mm':mmToIn(j.daily.precipitation_sum?.[i]??0)+' in'}`;
    el.daily.appendChild(div);
  }
}
el.units.onchange=()=>{const c=map.getCenter();updateWeather(c.lat,c.lng,'Updated units');};

loadRadar(); setInterval(loadRadar,5*60*1000);
navigator.geolocation?.getCurrentPosition(
 pos=>{map.setView([pos.coords.latitude,pos.coords.longitude],10);updateWeather(pos.coords.latitude,pos.coords.longitude,'My location');},
 ()=>updateWeather(53.35,-6.26,'Dublin area'));
</script>
</body>
</html>
