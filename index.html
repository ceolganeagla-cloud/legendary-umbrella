<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ceol Gan Eagla ‚Äî Weather</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; }
    #map { height: 50vh; width: 100%; }
    #controls { padding: 10px; background: #222; }
    select, input { margin: 5px; padding: 5px; }
    .info { padding: 10px; background: #333; margin: 10px; border-radius: 8px; }
  </style>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <label for="source">Weather Source:</label>
    <select id="source">
      <option value="tomorrow">Tomorrow.io</option>
      <option value="speedome">Speedome</option>
    </select>
    <input id="search" placeholder="Enter place or Eircode" />
    <button onclick="getLocation()">üìç Me</button>
    <button onclick="searchPlace()">üîç Search</button>
  </div>

  <div class="info" id="current"></div>
  <div class="info" id="forecast"></div>

  <script>
    const API_BASE = "https://<your-project>.vercel.app"; // replace with your Vercel domain

    let map = L.map("map").setView([53.34, -6.26], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap",
    }).addTo(map);

    async function fetchTomorrow(lat, lon) {
      const r = await fetch(`${API_BASE}/api/tomorrow?lat=${lat}&lon=${lon}`, { cache: "no-store" });
      if (!r.ok) throw new Error("Tomorrow proxy failed");
      return await r.json();
    }

    async function fetchSpeedome(lat, lon) {
      const r = await fetch(`${API_BASE}/api/speedome?lat=${lat}&lon=${lon}`, { cache: "no-store" });
      if (!r.ok) throw new Error("Speedome proxy failed");
      return await r.json();
    }

    async function updateWeather(lat, lon) {
      const source = document.getElementById("source").value;
      let data;
      if (source === "tomorrow") {
        data = await fetchTomorrow(lat, lon);
      } else if (source === "speedome") {
        data = await fetchSpeedome(lat, lon);
      }

      renderWeather(data);
      map.setView([lat, lon], 10);
      L.marker([lat, lon]).addTo(map);
    }

    function renderWeather(data) {
      const cur = data.current || {};
      document.getElementById("current").innerHTML = `
        <h3>Current</h3>
        Temp: ${cur.tempC ?? "-"} ¬∞C<br/>
        Wind: ${cur.windMs ? (cur.windMs * 3.6).toFixed(1) : "-"} km/h<br/>
        Clouds: ${cur.cloud ?? "-"}%<br/>
        Precip: ${cur.precipMm ?? "-"} mm<br/>
        Sunrise: ${cur.sunrise ?? "-"}<br/>
        Sunset: ${cur.sunset ?? "-"}
      `;

      let dailyHtml = "<h3>Daily</h3>";
      if (data.daily && data.daily.time) {
        data.daily.time.forEach((t, i) => {
          dailyHtml += `${t.slice(0,10)}: ${data.daily.tmaxC[i]}¬∞C / ${data.daily.tminC[i]}¬∞C<br/>`;
        });
      }
      document.getElementById("forecast").innerHTML = dailyHtml;
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => updateWeather(pos.coords.latitude, pos.coords.longitude),
          err => alert("Location failed: " + err.message)
        );
      }
    }

    async function searchPlace() {
      const q = document.getElementById("search").value;
      if (!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      const r = await fetch(url);
      const j = await r.json();
      if (j.length > 0) {
        updateWeather(j[0].lat, j[0].lon);
      } else {
        alert("Place not found");
      }
    }

    // Auto-load Dublin
    updateWeather(53.34, -6.26);
  </script>
</body>
</html>
