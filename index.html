<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ceol Gan Eagla ‚Äî Weather & Marine</title>

<!-- Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{--bg:#0b1220;--panel:#12141c;--card:#1a1e29;--text:#eaeaea;--muted:#b9b9c2;--accent:#4dd0ff}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:1fr 420px;gap:12px;height:100vh;padding:12px}
#map{width:100%;height:100%;border-radius:14px;overflow:hidden;position:relative;background:#0a0f18}
aside{background:var(--panel);border-radius:14px;overflow:auto;padding:12px}

.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.logo{width:48px;height:48px;border-radius:10px;overflow:hidden;background:#000}
.logo img{width:100%;height:100%;object-fit:contain;background:#fff}
h1{margin:0;font-size:18px}
.sub{color:var(--muted);font-size:12px}

.card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:0;padding:8px 10px;border-radius:10px;background:#fff;color:#111;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.2)}
input[type=text],select{background:#0f131c;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px}
input[type=range]{width:180px}
.chip{padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.08);font-size:12px}

#hourly{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px}
.hour{min-width:92px;background:rgba(255,255,255,.06);border-radius:10px;padding:8px;text-align:center}
#daily{display:grid;grid-template-columns:repeat(7,minmax(90px,1fr));gap:8px}
.day{background:rgba(255,255,255,.06);border-radius:10px;padding:8px;text-align:center}

/* Map badge + floating Speedome button */
.map-badge{position:absolute;left:58px;top:10px;background:rgba(18,18,22,.9);color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:8px;font-size:12px;z-index:650;pointer-events:none}
.leaflet-top.leaflet-left .leaflet-control-zoom{margin-top:10px;margin-left:10px}
.fab{position:absolute;right:12px;bottom:12px;z-index:700;background:#fff;color:#111;border-radius:999px;padding:10px 12px;box-shadow:0 4px 12px rgba(0,0,0,.35);cursor:pointer;font-weight:800}
.fab:active{transform:translateY(1px)}

/* Speedome HUD */
#speedHUD{position:fixed;left:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;padding:18px;background:rgba(10,15,24,.92);backdrop-filter:blur(3px);z-index:9000}
.speedWrap{display:flex;flex-direction:column;align-items:center;gap:8px}
.speedVal{font-size:64px;line-height:1;font-weight:900;letter-spacing:2px}
.bar{height:6px;width:260px;border-radius:999px;background:#1f2a3a;overflow:hidden}
.fill{height:100%;width:0;background:linear-gradient(90deg,#36f,#4dd0ff);transition:width .2s}
.speedUnits{font-size:14px;color:var(--muted)}
.speedMeta{display:flex;gap:12px;color:var(--muted);font-size:12px}
#closeSpeed{position:absolute;right:12px;top:12px}
.maxChip{background:#142133;border:1px solid #27425e;border-radius:999px;padding:4px 10px}

/* Disabled toggle look */
.disabled{opacity:.5;pointer-events:none}

@media (max-width:920px){.app{grid-template-columns:1fr;grid-template-rows:52vh 1fr}}
#err{position:fixed;left:8px;right:8px;bottom:8px;background:#b00020;color:#fff;border-radius:8px;padding:8px;display:none;z-index:9999}
</style>
</head>
<body>
<div class="app">
  <div id="map">
    <div id="badge" class="map-badge">Locating‚Ä¶</div>
    <div id="speedFab" class="fab" title="Speed HUD">‚õµ</div>
  </div>

  <aside>
    <div class="brand">
      <div class="logo"><img src="logo.png" alt="Logo" onerror="this.onerror=null;this.src='icon-192.png'"></div>
      <div>
        <h1>Ceol Gan Eagla ‚Äî Weather & Marine</h1>
        <div class="sub">Sources: OSM ‚Ä¢ MapTiler ‚Ä¢ RainViewer ‚Ä¢ Open-Meteo ‚Ä¢ Nominatim ‚Ä¢ (Tomorrow.io via proxy)</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <input id="search" type="text" placeholder="Search place or Eircode‚Ä¶" style="flex:1;min-width:220px">
        <button id="btnSearch" class="btn" type="button">üîç Search</button>
        <button id="speedoBtn" class="btn ghost" type="button">‚õµ Speedome</button>
      </div>
      <div class="row">
        <button id="btnGeo" class="btn" type="button">üìç Me</button>
        <button id="btnPin" class="btn ghost" type="button">üìå Pin</button>
        <label>Units
          <select id="units" class="btn ghost">
            <option value="metric" selected>Metric (¬∞C, m/s, mm)</option>
            <option value="imperial">Imperial (¬∞F, mph, in)</option>
          </select>
        </label>
        <label>Map
          <select id="mapStyle" class="btn ghost">
            <option value="streets" selected>Streets</option>
            <option value="outdoor">Outdoor (terrain)</option>
            <option value="satellite">Satellite</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Waterways controls -->
    <div class="card">
      <div class="row" style="margin-bottom:6px">
        <div class="sub">Waterways info (OSM)</div>
      </div>
      <div class="row" style="gap:12px">
        <label><input type="checkbox" id="wwToggle"> Show waterways POIs</label>
        <select id="wwFilter" class="btn ghost">
          <option value="all" selected>All</option>
          <option value="locks">Locks/Weirs/Dams</option>
          <option value="slipways">Slipways</option>
          <option value="marinas">Marinas/Moorings</option>
          <option value="piers">Piers/Jetties</option>
          <option value="fuel">Boat Fuel</option>
        </select>
        <span id="wwStatus" class="sub">‚Äî</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="play" class="btn ghost" type="button" title="Play radar">‚ñ∂Ô∏é</button>
        <input id="frame" type="range" min="0" max="0" step="1" value="0">
        <span id="frametime" class="sub">‚Äî</span>
        <label style="margin-left:auto">Radar opacity
          <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.7">
        </label>
        <button id="refresh" class="btn ghost" type="button">‚Üª Refresh</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div id="nowIcon" class="chip">‚òÅ</div>
        <div id="temp" class="chip">Temp ‚Äî</div>
        <div id="wind" class="chip">Wind ‚Äî</div>
        <div id="precip" class="chip">Precip ‚Äî</div>
        <div id="cloud" class="chip">Cloud ‚Äî</div>
        <div id="sun" class="chip">Sunrise ‚Äî / Sunset ‚Äî</div>
        <div id="risk" class="chip">‚Äî</div>
        <div id="updated" class="chip">‚Äî</div>
      </div>
      <div class="row" style="margin-top:8px">
        <!-- Always visible; disabled if proxy unreachable -->
        <label id="tomorrowWrap"><input type="checkbox" id="useTomorrow" checked> Use Tomorrow.io wind</label>
        <span id="tioNote" class="sub" style="margin-left:6px;"></span>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Your GPS (boat) speed</div>
      <div class="row">
        <div id="gps" class="chip">‚è± 0 km/h</div>
        <button id="toggleSpeed" class="btn ghost" type="button">Units: km/h</button>
        <div id="heading" class="chip">üß≠ ‚Äî¬∞</div>
        <div id="max" class="chip">üèÅ Max: 0</div>
        <button id="toggleHUD" class="btn" type="button">Speedome HUD</button>
      </div>
    </div>

    <div class="card">
      <div class="sub" style="margin-bottom:6px">Next 24 hours</div>
      <div id="hourly">Loading‚Ä¶</div>
    </div>
    <div class="card">
      <div class="sub" style="margin-bottom:6px">7-day forecast</div>
      <div id="daily">Loading‚Ä¶</div>
    </div>
  </aside>
</div>

<!-- Speedome HUD -->
<div id="speedHUD">
  <button id="closeSpeed" class="btn">Close</button>
  <div class="speedWrap">
    <div class="speedVal" id="hudVal">0</div>
    <div class="bar"><div class="fill" id="hudFill"></div></div>
    <div class="speedUnits" id="hudUnits">km/h</div>
    <div class="speedMeta">
      <span id="hudHead">üß≠ ‚Äî¬∞</span>
      <span class="maxChip" id="hudMax">üèÅ Max 0</span>
      <button id="hudToggle" class="btn ghost" type="button">Toggle Units</button>
    </div>
  </div>
</div>

<div id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* CONFIG
   If this HTML is on the SAME Vercel domain as your API, leave API_BASE = ''.
   If hosted elsewhere (e.g., GitHub Pages), set it to your Vercel URL.
   Example: const API_BASE = 'https://your-app.vercel.app';
*/
const API_BASE = '';

/* Error banner */
window.onerror = function(msg){ const e=document.getElementById('err'); e.textContent='Error: '+msg; e.style.display='block'; };

(function(){
  const MAPTILER_KEY = 'MpDV384cXMNO273WsuTG';

  /* Elements */
  const $ = id => document.getElementById(id);
  const el = {
    badge:$('badge'), speedFab:$('speedFab'),
    search:$('search'), btnSearch:$('btnSearch'),
    btnGeo:$('btnGeo'), btnPin:$('btnPin'),
    units:$('units'), mapStyle:$('mapStyle'),
    play:$('play'), frame:$('frame'), frametime:$('frametime'),
    opacity:$('opacity'), refresh:$('refresh'),
    nowIcon:$('nowIcon'), temp:$('temp'), wind:$('wind'), precip:$('precip'),
    cloud:$('cloud'), sun:$('sun'), risk:$('risk'), updated:$('updated'),
    hourly:$('hourly'), daily:$('daily'),
    gps:$('gps'), toggleSpeed:$('toggleSpeed'), heading:$('heading'), max:$('max'),
    speedoBtn:$('speedoBtn'), speedHUD:$('speedHUD'), closeSpeed:$('closeSpeed'),
    hudVal:$('hudVal'), hudUnits:$('hudUnits'), hudFill:$('hudFill'),
    hudHead:$('hudHead'), hudMax:$('hudMax'), hudToggle:$('hudToggle'),
    tomorrowWrap:$('tomorrowWrap'), useTomorrow:$('useTomorrow'), tioNote:$('tioNote'),
    toggleHUD:$('toggleHUD')
  };

  /* Map */
  const map = L.map('map',{zoomControl:true}).setView([53.35,-6.26],8);
  const styles = {
    streets:`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
    outdoor:`https://api.maptiler.com/maps/outdoor-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
    satellite:`https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`
  };
  let base = L.tileLayer(styles.streets,{attribution:'&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler'}).addTo(map);
  const markers = L.featureGroup().addTo(map);

  map.createPane('radar'); map.getPane('radar').style.zIndex=450;
  const radarLayer = L.tileLayer('',{pane:'radar',opacity:0.7}).addTo(map);

  /* Helpers */
  let speedUnit='kmh', lastSpeedMs=0, maxSpeed=0, gpsWatchId=null, gotFix=false, radarTimer=null;
  const toF=c=>Math.round(c*9/5+32), msToMph=ms=>Math.round(ms*2.23694), mmToIn=mm=>Math.round(mm/25.4*100)/100, msToKn=ms=>Math.round(ms*1.94384);
  const iconFor=()=> '‚òÅ';
  const fmtSpeed=ms=>{ ms=(ms==null||isNaN(ms))?0:ms; if(speedUnit==='kmh')return Math.round(ms*3.6)+' km/h'; if(speedUnit==='mph')return Math.round(ms*2.23694)+' mph'; return msToKn(ms)+' knots'; };
  function setMarker(lat,lon,label){ markers.clearLayers(); L.marker([lat,lon]).addTo(markers).bindPopup(label||'Here').openPopup(); }
  function toggleHUD(open){ const s=el.speedHUD; if(!s)return; if(typeof open==='boolean') s.style.display=open?'flex':'none'; else s.style.display=(s.style.display==='flex')?'none':'flex'; }

  /* Style switch */
  el.mapStyle.addEventListener('change', e=>{ const v=e.target.value; if(base) map.removeLayer(base); base=L.tileLayer(styles[v],{attribution:'&copy; OpenStreetMap ‚Ä¢ &copy; MapTiler'}).addTo(map); });

  /* Radar */
  const RV={frames:[],idx:0};
  function loadRadar(){
    fetch('https://api.rainviewer.com/public/weather-maps.json',{cache:'no-store'})
      .then(r=>r.json()).then(j=>{ RV.frames=[...(j?.radar?.past||[]),...(j?.radar?.nowcast||[])]; el.frame.max=Math.max(RV.frames.length-1,0); setRadar(RV.frames.length-1); }).catch(()=>{});
  }
  function setRadar(i){
    if(!RV.frames.length) return;
    RV.idx=Math.max(0,Math.min(i,RV.frames.length-1));
    const fr=RV.frames[RV.idx]; if(!fr) return;
    radarLayer.setUrl(`https://tilecache.rainviewer.com/v2/radar/${fr.time}/256/{z}/{x}/{y}/2/1_1.png`);
    el.frametime.textContent=new Date(fr.time*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  }
  el.frame.addEventListener('input', e=>setRadar(+e.target.value));
  el.play.addEventListener('click', ()=>{ if(radarTimer){clearInterval(radarTimer);radarTimer=null;el.play.textContent='‚ñ∂Ô∏é';return;} if(!RV.frames.length)return; el.play.textContent='‚è∏'; radarTimer=setInterval(()=>{ const n=(RV.idx+1)%RV.frames.length; el.frame.value=n; setRadar(n); },700); });
  el.opacity.addEventListener('input', e=>radarLayer.setOpacity(+e.target.value));
  el.refresh.addEventListener('click', loadRadar);

  /* Search / Geo */
  function doSearch(){
    const q=el.search.value.trim(); if(!q) return;
    const eir=/^[A-Z0-9]{3}\s?[A-Z0-9]{4}$/i;
    const url=eir.test(q)?`https://nominatim.openstreetmap.org/search?postalcode=${q.replace(/\s+/g,'')}&countrycodes=ie&format=json&addressdetails=1&limit=5`:`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`;
    fetch(url,{headers:{'Accept-Language':'en'}}).then(r=>r.json()).then(arr=>{ if(!arr?.length)return; const lat=parseFloat(arr[0].lat),lon=parseFloat(arr[0].lon),name=arr[0].display_name||'Location'; map.setView([lat,lon],11); setMarker(lat,lon,name); updateAll(lat,lon,name); }).catch(()=>{});
  }
  el.btnSearch.addEventListener('click', doSearch);
  el.search.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
  el.btnGeo.addEventListener('click', ()=>{ if(!navigator.geolocation)return; navigator.geolocation.getCurrentPosition(pos=>{ const {latitude:lat,longitude:lon}=pos.coords; map.setView([lat,lon],11); setMarker(lat,lon,'You are here'); updateAll(lat,lon,'My location'); }); });
  el.btnPin.addEventListener('click', ()=>{ const c=map.getCenter(); setMarker(c.lat,c.lng,'Pinned point'); updateAll(c.lat,c.lng,'Pinned point'); });

  /* Weather (Open-Meteo) */
  el.units.addEventListener('change', ()=>{ const c=map.getCenter(); updateAll(c.lat,c.lng,'Updated units'); });

  function updateAll(lat,lon,label){
    el.badge.textContent=`${label||'Here'} ‚Ä¢ ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    updateForecast(lat,lon).then(()=>{ if(el.useTomorrow?.checked && !el.useTomorrow.disabled) updateTomorrow(lat,lon); });
  }

  function updateForecast(lat,lon){
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation,cloudcover,windspeed_10m,weathercode,snowfall&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset&forecast_days=7&timezone=auto`;
    return fetch(url,{cache:'no-store'}).then(r=>r.json()).then(j=>{
      const metric=(el.units.value==='metric');
      const tNow=j?.current_weather?.temperature;
      const wArr=j?.hourly?.windspeed_10m||[], pArr=j?.hourly?.precipitation||[], cArr=j?.hourly?.cloudcover||[], sArr=j?.hourly?.snowfall||[];
      const sunrise=j?.daily?.sunrise?.[0], sunset=j?.daily?.sunset?.[0];
      const wMs=wArr[0], pMm=pArr[0], cl=cArr[0], snow=sArr[0];

      el.nowIcon.textContent=iconFor();
      el.temp.textContent=(tNow==null)?'Temp ‚Äî':(metric?Math.round(tNow)+'¬∞C':toF(tNow)+'¬∞F');
      el.wind.dataset.source='openmeteo';
      el.wind.textContent=(wMs==null)?'Wind ‚Äî':(metric?'Wind '+Math.round(wMs)+' m/s':'Wind '+msToMph(wMs)+' mph');
      el.precip.textContent=(pMm==null)?'Precip ‚Äî':(metric?'Precip '+pMm+' mm':'Precip '+mmToIn(pMm)+' in');
      el.cloud.textContent=(cl==null)?'Cloud ‚Äî':'Cloud '+cl+'%';
      el.sun.textContent=(sunrise&&sunset)?`Sunrise ${new Date(sunrise).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} / Sunset ${new Date(sunset).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`:'Sunrise ‚Äî / Sunset ‚Äî';
      el.risk.textContent=(snow>0?'‚ùÑ snow':'') + ((cl<=0 && pMm>0)?' ‚Ä¢ üåß rain':'') + (snow>0?' ‚Ä¢ üßä ice risk':'');
      el.updated.textContent='Updated '+new Date().toLocaleTimeString();

      // Hourly 24
      el.hourly.innerHTML='';
      const H=Math.min(24,(j?.hourly?.time||[]).length);
      for(let i=0;i<H;i++){
        const ti=j.hourly.time[i].slice(11,16), tc=j.hourly.temperature_2m[i], pp=j.hourly.precipitation[i];
        const div=document.createElement('div');
        div.className='hour';
        div.innerHTML=`${ti}<div class="ico">‚òÅ</div>${metric?Math.round(tc)+'¬∞C':toF(tc)+'¬∞F'}<br>${metric?pp+' mm':mmToIn(pp)+' in'}`;
        el.hourly.appendChild(div);
      }
      // Daily 7
      el.daily.innerHTML='';
      const D=(j?.daily?.time||[]).length;
      for(let d=0; d<D; d++){
        const wd=new Date(j.daily.time[d]).toLocaleDateString(undefined,{weekday:'short'});
        const tmax=j.daily.temperature_2m_max[d], tmin=j.daily.temperature_2m_min[d], pr=j.daily.precipitation_sum?.[d]??0;
        const row=document.createElement('div');
        row.className='day';
        row.innerHTML=`${wd}<div class="ico">‚òÅ</div>${metric?Math.round(tmax)+'¬∞C / '+Math.round(tmin)+'¬∞C':toF(tmax)+'¬∞F / '+toF(tmin)+'¬∞F'}<br>${metric?pr+' mm':mmToIn(pr)+' in'}`;
        el.daily.appendChild(row);
      }
    }).catch(()=>{ el.updated.textContent='Live forecast failed'; });
  }

  /* Tomorrow.io via proxy (always show toggle; disable if offline) */
  function markTio(state,msg){
    if(state==='ok'){ el.useTomorrow.disabled=false; el.tomorrowWrap.classList.remove('disabled'); el.tioNote.textContent=''; }
    else { el.useTomorrow.disabled=true; el.tomorrowWrap.classList.add('disabled'); el.tioNote.textContent=msg||'(proxy offline)'; }
  }
  // Probe the proxy once
  fetch(`${API_BASE}/api/tomorrow?lat=53.35&lon=-6.26`,{cache:'no-store'})
    .then(r=>{ if(r.ok) markTio('ok'); else markTio('err'); })
    .catch(()=> markTio('err'));

  function updateTomorrow(lat,lon){
    if (!el.useTomorrow || !el.useTomorrow.checked || el.useTomorrow.disabled) return;
    const metric=(el.units.value==='metric');
    const u = metric ? 'metric' : 'imperial';
    fetch(`${API_BASE}/api/tomorrow?lat=${lat}&lon=${lon}&units=${u}`, { cache:'no-store' })
      .then(r=>r.json())
      .then(j=>{
        const ws = j?.data?.values?.windSpeed; // m/s (metric)
        if (ws==null) return;
        el.wind.dataset.source='tomorrow';
        el.wind.textContent = metric ? (`Wind ${Math.round(ws)} m/s (Tomorrow.io)`)
                                     : (`Wind ${Math.round(ws*2.23694)} mph (Tomorrow.io)`);
      })
      .catch(()=>{ /* leave Open-Meteo wind */ });
  }
  el.useTomorrow.addEventListener('change', ()=>{ const c=map.getCenter(); updateAll(c.lat,c.lng,'Updated wind source'); });

  /* ===== Waterways (OSM Overpass) ===== */
  const ww = {
    layer: L.featureGroup().addTo(map),
    busy: false,
    lastFetchAt: 0
  };
  ww.layer.remove(); // keep hidden until toggled on

  const elWwToggle = document.getElementById('wwToggle');
  const elWwFilter = document.getElementById('wwFilter');
  const elWwStatus = document.getElementById('wwStatus');

  function wwEmoji(tags){
    if (tags.waterway === 'lock_gate') return 'üóùÔ∏è';
    if (tags.waterway === 'weir') return 'üåä';
    if (tags.waterway === 'dam') return 'üß±';
    if (tags.leisure === 'slipway') return 'üõ∂';
    if (tags.leisure === 'marina' || tags['seamark:type'] === 'mooring') return '‚õµ';
    if (tags.man_made === 'pier' || tags.man_made === 'jetty') return 'üõ≥Ô∏è';
    if (tags.amenity === 'fuel') return '‚õΩ';
    if (tags.harbour === 'yes' || tags['seamark:type'] === 'harbour') return '‚öì';
    return 'üìç';
  }

  function wwFilters(){
    const v = elWwFilter?.value || 'all';
    const parts = [];
    if (v === 'all' || v === 'locks') parts.push('node["waterway"~"lock_gate|weir|dam"]');
    if (v === 'all' || v === 'slipways') parts.push('node["leisure"="slipway"]');
    if (v === 'all' || v === 'marinas') parts.push('node["leisure"="marina"]', 'node["seamark:type"="mooring"]');
    if (v === 'all' || v === 'piers') parts.push('node["man_made"~"pier|jetty"]');
    if (v === 'all' || v === 'fuel') parts.push('node["amenity"="fuel"]');
    if (v === 'all') parts.push('node["harbour"="yes"]', 'node["seamark:type"="harbour"]');
    return parts;
  }

  async function loadWaterways(){
    if (!elWwToggle?.checked) return;
    const now = Date.now();
    if (ww.busy || (now - ww.lastFetchAt < 2000)) return; // simple rate limit
    ww.busy = true; ww.lastFetchAt = now;
    elWwStatus.textContent = 'Loading‚Ä¶';

    const b = map.getBounds();
    const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
    const queries = wwFilters().map(q => `${q}(${bbox});`).join('\n');

    const overpassQL = `
[out:json][timeout:15];
(
  ${queries}
);
out center tags;`;

    try{
      const r = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: 'data=' + encodeURIComponent(overpassQL)
      });
      const j = await r.json();

      ww.layer.clearLayers();
      (j.elements||[]).forEach(e=>{
        const lat = e.lat || e.center?.lat, lon = e.lon || e.center?.lon;
        if (lat==null || lon==null) return;
        const m = L.marker([lat,lon], { title: e.tags?.name || '' })
          .bindPopup(`
            <div style="min-width:180px">
              <div style="font-size:18px">${wwEmoji(e.tags)} ${e.tags?.name || '(no name)'}</div>
              <div style="font-size:12px;color:#bbb">${e.tags?.waterway || e.tags?.leisure || e.tags?.man_made || e.tags?.amenity || e.tags?.harbour || e.tags?.["seamark:type"] || 'poi'}</div>
              ${e.tags?.operator ? `<div>Operator: ${e.tags.operator}</div>`:''}
              ${e.tags?.opening_hours ? `<div>Hours: ${e.tags.opening_hours}</div>`:''}
              ${(e.tags?.website||e.tags?.contact_website) ? `<div><a href="${e.tags.website||e.tags.contact_website}" target="_blank" rel="noopener">Website</a></div>`:''}
              <div class="sub">OSM data (may be incomplete)</div>
            </div>
          `);
        ww.layer.addLayer(m);
      });

      if (!map.hasLayer(ww.layer)) ww.layer.addTo(map);
      elWwStatus.textContent = `${ww.layer.getLayers().length} features`;
    } catch(err){
      elWwStatus.textContent = 'Failed';
      console.warn('Overpass failed', err);
    } finally {
      ww.busy = false;
    }
  }

  /* Toggle & refresh */
  elWwToggle?.addEventListener('change', ()=>{
    if (elWwToggle.checked) {
      if (!map.hasLayer(ww.layer)) ww.layer.addTo(map);
      loadWaterways();
    } else {
      if (map.hasLayer(ww.layer)) map.removeLayer(ww.layer);
      elWwStatus.textContent = '‚Äî';
    }
  });
  elWwFilter?.addEventListener('change', ()=>{ loadWaterways(); });

  /* Reload on map movement (debounced) */
  let wwDebounce;
  map.on('moveend', ()=>{
    if (!elWwToggle?.checked) return;
    clearTimeout(wwDebounce);
    wwDebounce = setTimeout(loadWaterways, 400);
  });

  /* GPS (Speedome) */
  function updateSpeedUI(heading){
    el.gps.textContent='‚è± '+fmtSpeed(lastSpeedMs);
    const val = speedUnit==='kmh'? lastSpeedMs*3.6 : speedUnit==='mph'? lastSpeedMs*2.23694 : lastSpeedMs*1.94384;
    const cap = speedUnit==='kmh'? 60 : speedUnit==='mph'? 40 : 30;
    el.hudVal.textContent=Math.round(val);
    el.hudUnits.textContent=(speedUnit==='kmh'?'km/h':speedUnit==='mph'?'mph':'knots');
    el.hudFill.style.width=Math.min(100,Math.round(val/cap*100))+'%';
    el.hudHead.textContent='üß≠ '+(isFinite(heading)?Math.round(heading)+'¬∞':'‚Äî¬∞');
    el.hudMax.textContent='üèÅ Max '+(speedUnit==='kmh'?Math.round(maxSpeed*3.6):speedUnit==='mph'?Math.round(maxSpeed*2.23694):Math.round(maxSpeed*1.94384));
    el.toggleSpeed.textContent='Units: '+(speedUnit==='kmh'?'km/h':speedUnit==='mph'?'mph':'knots');
    el.max.textContent='üèÅ Max: '+fmtSpeed(maxSpeed);
    el.heading.textContent='üß≠ '+(isFinite(heading)?Math.round(heading)+'¬∞':'‚Äî¬∞');
  }
  function startGPS(){
    if(!navigator.geolocation){ el.gps.textContent='‚è± GPS not supported'; return; }
    if(gpsWatchId!==null) return;
    gpsWatchId=navigator.geolocation.watchPosition(pos=>{
      const {latitude:lat, longitude:lon, speed, heading}=pos.coords;
      lastSpeedMs=(speed==null)?0:speed;
      if(lastSpeedMs>maxSpeed) maxSpeed=lastSpeedMs;
      updateSpeedUI(heading);
      el.badge.textContent=`${lat.toFixed(3)}, ${lon.toFixed(3)} ‚Ä¢ ${fmtSpeed(lastSpeedMs)}`;
      if(!gotFix){ gotFix=true; map.setView([lat,lon],11); setMarker(lat,lon,'You are here'); updateAll(lat,lon,'My location'); }
    }, ()=>{ el.gps.textContent='‚è± GPS unavailable'; }, {enableHighAccuracy:true,maximumAge:4000,timeout:20000});
  }
  el.toggleSpeed.addEventListener('click', ()=>{ speedUnit=(speedUnit==='kmh')?'mph':(speedUnit==='mph')?'knots':'kmh'; updateSpeedUI(NaN); });
  el.speedoBtn.addEventListener('click', ()=>toggleHUD());
  el.speedFab.addEventListener('click', ()=>toggleHUD());
  el.toggleHUD.addEventListener('click', ()=>toggleHUD());
  el.closeSpeed.addEventListener('click', ()=>toggleHUD(false));
  el.hudToggle.addEventListener('click', ()=>el.toggleSpeed.click());

  /* Init */
  loadRadar(); setInterval(loadRadar,5*60*1000);
  startGPS();

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      p=>{ const {latitude:lat,longitude:lon}=p.coords; map.setView([lat,lon],11); updateAll(lat,lon,'My location'); },
      ()=>updateAll(53.35,-6.26,'Dublin area')
    );
  } else updateAll(53.35,-6.26,'Dublin area');

})();
</script>
</body>
</html>
