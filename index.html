<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Legendary Umbrella — Marine Weather & Nav</title>
<link rel="icon" href="favicon.ico" />
<meta name="theme-color" content="#0a0f15" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0a0f15; --panel:#0f1620; --card:#111a27; --line:#203045;
  --ink:#e9f0f8; --muted:#9fb2c8; --accent:#22c55e; --danger:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
header{padding:14px 16px;border-bottom:1px solid var(--line)}
h1{font-size:20px;margin:6px 0 0}
.brand{display:inline-block;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#0d1a26;font-size:13px}
.status{display:block;font-size:12px;color:var(--muted);margin-top:6px;word-break:break-all}

main{display:grid;grid-template-columns:1fr;gap:10px;height:calc(100svh - 80px);padding:10px}
@media(min-width:980px){ main{grid-template-columns:1fr 360px;} }

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer;border:1px solid var(--line);background:#111a27;color:var(--ink);border-radius:12px;padding:10px 12px;font-size:14px}
button.active{outline:2px solid var(--accent)}
#map{height:65svh;min-height:420px;border-radius:14px}

.metric{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:14px}
.metric .muted{color:var(--muted)}

.fab{position:fixed;right:18px;bottom:18px;z-index:9999;width:64px;height:64px;border-radius:999px;background:#0f1824;border:1px solid var(--line);display:grid;place-items:center}
.fab svg{width:26px;height:26px;fill:var(--ink)}

.sheet{position:fixed;left:0;right:0;bottom:0;z-index:10000;transform:translateY(100%);transition:.25s transform ease; background:var(--panel);border-top:1px solid var(--line);border-radius:16px 16px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,.35);max-height:70svh;overflow:auto}
.sheet.open{transform:translateY(0)}
.sheet .row{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
.chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer;background:#0e1724}
.chip input{margin-right:6px}

.icon-veh{filter: drop-shadow(0 0 2px rgba(0,0,0,.6));}
.leaflet-control-attribution{font-size:11px}

.speedo{padding:12px}
.gauge{width:220px;height:110px;border-bottom-left-radius:220px;border-bottom-right-radius:220px;background:linear-gradient(180deg,#1a2838, #162234);border:1px solid var(--line);position:relative;margin:0 auto}
.needle{position:absolute;bottom:0;left:50%;width:2px;height:100px;background:#fafafa;box-shadow:0 0 6px rgba(255,255,255,.7);transform-origin:bottom center;transform:translateX(-50%) rotate(180deg)}
.ticks{position:absolute;inset:0}
.speed-read{text-align:center;font-size:24px;margin-top:8px}
.units{text-align:center;font-size:12px;color:var(--muted);margin-top:-4px}
</style>
</head>
<body>
<header>
  <span class="brand">Ceol Gan Eagla</span>
  <h1>Legendary Umbrella — Marine Weather & Nav</h1>
  <small class="status" id="status">Booting…</small>
</header>

<main>
  <section>
    <div class="card">
      <div class="toolbar" style="margin-bottom:8px">
        <button id="btnTrack">Start tracking</button>
        <button id="btnCenter">Center on me</button>
        <button id="btnFull">Fullscreen</button>
      </div>
      <div id="map"></div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted)">
        Basemaps:
        <span class="chip">OpenStreetMap</span>
        <span class="chip">Esri Ocean</span>
        <span class="chip">Esri Imagery</span>
        <span class="chip">OpenTopoMap</span>
        & overlays
        <span class="chip">Seamarks</span>,
        <span class="chip">Rivers/Waterways</span>,
        <span class="chip">Harbours</span>,
        <span class="chip">Fuel/Piers</span>.
      </div>
    </div>

    <div class="card" id="wxCard" style="margin-top:10px">
      <div class="toolbar" style="margin-bottom:6px">
        <button id="btnGeo">Use my location</button>
        <input id="city" placeholder="Enter city (e.g., Dublin)" style="flex:1;min-width:160px;background:#0e1320;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px 12px" />
        <button id="btnCity">Get weather</button>
        <span class="muted" style="align-self:center;font-size:12px">API base: <b id="apiBaseTxt">—</b></span>
      </div>
      <div class="metric" id="wx">
        <div class="muted">Temp:</div><b id="mTemp">—</b>
        <div class="muted">Wind:</div><b id="mWind">—</b>
        <div class="muted">Gust:</div><b id="mGust">—</b>
        <div class="muted">Direction:</div><b id="mDir">—</b>
        <div class="muted">Precip Prob:</div><b id="mPop">—</b>
        <div class="muted">Cloud Cover:</div><b id="mCloud">—</b>
      </div>
      <pre id="raw" style="display:none"></pre>
      <div id="err" class="card" style="display:none;background:#2a0f0f;border-color:#5a1d1d;margin-top:8px"></div>
    </div>
  </section>

  <aside>
    <div class="card speedo">
      <div class="gauge">
        <div id="needle" class="needle"></div>
        <svg class="ticks" viewBox="0 0 100 50" preserveAspectRatio="none">
          <g stroke="#334a63" stroke-width="0.6">
            <line x1="5" y1="48" x2="5" y2="44"/>
            <line x1="15" y1="48" x2="15" y2="44"/>
            <line x1="25" y1="48" x2="25" y2="44"/>
            <line x1="35" y1="48" x2="35" y2="44"/>
            <line x1="45" y1="48" x2="45" y2="44"/>
            <line x1="55" y1="48" x2="55" y2="44"/>
            <line x1="65" y1="48" x2="65" y2="44"/>
            <line x1="75" y1="48" x2="75" y2="44"/>
            <line x1="85" y1="48" x2="85" y2="44"/>
            <line x1="95" y1="48" x2="95" y2="44"/>
          </g>
        </svg>
      </div>
      <div id="spd" class="speed-read">0.0</div>
      <div class="units">knots (kn)</div>
      <div class="muted" style="text-align:center;margin-top:6px">Uses GPS speed; falls back to distance over time if speed is missing.</div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:6px">Position</div>
      <div class="metric">
        <div class="muted">Lat:</div><b id="pLat">—</b>
        <div class="muted">Lon:</div><b id="pLon">—</b>
        <div class="muted">Acc:</div><b id="pAcc">—</b>
        <div class="muted">Bearing:</div><b id="pBrg">—</b>
      </div>
    </div>
  </aside>
</main>

<!-- Floating action button to open options -->
<button id="fab" class="fab" aria-label="Layers & Live">
  <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
</button>

<!-- Bottom sheet with layer toggles -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="row" style="border-bottom:1px solid var(--line)">
    <b style="font-size:14px">Basemaps</b>
    <label class="chip"><input type="radio" name="basemap" value="osm" checked/> OSM</label>
    <label class="chip"><input type="radio" name="basemap" value="ocean"/> Esri Ocean</label>
    <label class="chip"><input type="radio" name="basemap" value="sat"/> Esri Imagery</label>
    <label class="chip"><input type="radio" name="basemap" value="topo"/> OpenTopoMap</label>
  </div>
  <div class="row" style="border-bottom:1px solid var(--line)">
    <b style="font-size:14px">Overlays</b>
    <label class="chip"><input id="chkSeamarks" type="checkbox" /> Seamarks</label>
    <label class="chip"><input id="chkRivers"   type="checkbox" /> Rivers/Waterways</label>
    <label class="chip"><input id="chkHarbours" type="checkbox" /> Harbours</label>
    <label class="chip"><input id="chkFuel"     type="checkbox" /> Fuel / Piers</label>
  </div>
  <div class="row">
    <b style="font-size:14px">Live</b>
    <label class="chip"><input id="chkAircraft" type="checkbox" /> Aircraft</label>
    <label class="chip"><input id="chkBoats"    type="checkbox" /> Boats / Ships</label>
  </div>
</div>

<script>
/* --- tiny rotated marker helper (inline from Leaflet.RotatedMarker MIT) --- */
(function(){const proto=L.Marker.prototype,_setPos=proto._setPos;proto._setPos=function(pos){_setPos.call(this,pos);if(!this.options.rotationAngle) return; this._icon.style.transformOrigin=this.options.rotationOrigin||"center"; const a=this.options.rotationAngle; const t=this._icon.style.transform.replace(/ ?rotate\(.*\)/,''); this._icon.style.transform=t+' rotate(' + a + 'deg)';}; proto.setRotationAngle=function(a){this.options.rotationAngle=a; this.update();};})();

/* ===== hosting base ===== */
const ON_VERCEL = location.hostname.endsWith('.vercel.app');
const ON_LOCAL  = ['localhost','127.0.0.1'].includes(location.hostname);
const API_BASE  = (ON_VERCEL || ON_LOCAL) ? '' : 'https://legendary-umbrella-ashen.vercel.app';
document.getElementById('apiBaseTxt').textContent = API_BASE || '(same-origin)';

const $ = id => document.getElementById(id);
const setStatus = t => $('status').textContent = t;
const showErr = msg => { const e=$('err'); e.style.display='block'; e.textContent=msg; };
const clearErr = () => { const e=$('err'); e.style.display='none'; e.textContent=''; };

/* ===== weather helpers (unchanged) ===== */
async function getTioKey(){ const r=await fetch(`${API_BASE}/api/tio-key`,{cache:'no-store'}); if(!r.ok) throw new Error('tio-key '+r.status); const j=await r.json(); if(!j.key) throw new Error('No key'); return j.key; }
async function tmrForecastByLatLon(lat,lon,key){ const r=await fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1h&units=metric&apikey=${encodeURIComponent(key)}`); if(!r.ok) throw new Error('Tomorrow.io '+r.status); return r.json(); }
async function tmrGeocodeCity(name,key){ const r=await fetch(`https://api.tomorrow.io/v4/locations?search=${encodeURIComponent(name)}&apikey=${encodeURIComponent(key)}`); if(!r.ok) throw new Error('Geocode '+r.status); const j=await r.json(); const loc=j?.locations?.[0]; if(!loc) throw new Error('City not found'); return {lat:loc.lat,lon:loc.lon}; }
function setWX(data){
  const p = data?.timelines?.hourly?.[0]?.values || {};
  $('mTemp').textContent = (p.temperature??'—')+' °C';
  $('mWind').textContent = (p.windSpeed??'—')+' m/s';
  $('mGust').textContent = (p.windGust??'—')+' m/s';
  $('mDir').textContent  = (p.windDirection??'—')+'°';
  $('mPop').textContent  = (p.precipitationProbability??'—')+' %';
  $('mCloud').textContent= (p.cloudCover??'—')+' %';
}

/* ===== map & basemaps ===== */
let map, meMarker, meAcc, lastFix;
let baseOSM, baseOcean, baseSat, baseTopo, overlaySeamarks;
let riversLayer = L.layerGroup(), harboursLayer=L.layerGroup(), fuelLayer=L.layerGroup();
let aircraftLayer = L.layerGroup(), boatsLayer = L.layerGroup();

function initMap(){
  map = L.map('map', { center:[53.35,-6.26], zoom:10, minZoom:2 });

  baseOSM   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'});
  baseOcean = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',{maxZoom:13, attribution:'Esri Ocean'});
  baseSat   = L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19, attribution:'Esri Imagery'});
  baseTopo  = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17, attribution:'OpenTopoMap'});
  overlaySeamarks = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png',{maxZoom:18, opacity:.95, attribution:'OpenSeaMap'});

  baseOSM.addTo(map);

  $('btnFull').onclick = ()=>{ const el=$('map'); if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); };
  $('btnCenter').onclick = ()=>{ if(lastFix) map.setView([lastFix.coords.latitude,lastFix.coords.longitude], Math.max(14,map.getZoom())); };

  setTimeout(()=>map.invalidateSize(), 0);
}

/* ===== speedo + tracking ===== */
const R=6371000, toRad=d=>d*Math.PI/180;
function hav(a,b){ const φ1=toRad(a.lat),φ2=toRad(b.lat),dφ=toRad(b.lat-a.lat),dλ=toRad(b.lon-a.lon); const s=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2; return 2*R*Math.asin(Math.sqrt(s)); }
function msToKn(ms){ return (ms*1.943844)||0; }
function setNeedle(kn){ kn=Math.max(0,Math.min(50,kn)); const deg=180-(kn/50)*180; $('needle').style.transform=`translateX(-50%) rotate(${deg}deg)`; $('spd').textContent=kn.toFixed(1); }
function updateMeMarker(lat,lon,acc,brg){
  if(!meMarker){ meMarker=L.marker([lat,lon]).addTo(map); meAcc=L.circle([lat,lon],{radius:acc||0,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.12}).addTo(map); }
  else { meMarker.setLatLng([lat,lon]); meAcc.setLatLng([lat,lon]).setRadius(acc||0); }
  $('pLat').textContent=lat.toFixed(5); $('pLon').textContent=lon.toFixed(5);
  $('pAcc').textContent=acc? acc.toFixed(0)+' m':'—'; $('pBrg').textContent=Number.isFinite(brg)? Math.round(brg)+'°':'—';
}
let watchId=null;
$('btnTrack').onclick = ()=>{
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; $('btnTrack').textContent='Start tracking'; return; }
  watchId = navigator.geolocation.watchPosition(pos=>{
    lastFix=pos; const {latitude:lat,longitude:lon,accuracy:acc,heading, speed} = pos.coords;
    updateMeMarker(lat,lon,acc,heading);
    let mps = Number.isFinite(speed) && speed!==null ? speed : null;
    if(!mps && window.__prevFix){ const dt=(pos.timestamp-window.__prevFix.timestamp)/1000; if(dt>0){ const d=hav({lat:window.__prevFix.coords.latitude,lon:window.__prevFix.coords.longitude},{lat,lon}); mps=d/dt; } }
    window.__prevFix=pos; setNeedle(msToKn(mps||0));
  }, e=>showErr('GPS error: '+e.message), {enableHighAccuracy:true,timeout:15000,maximumAge:0});
  $('btnTrack').textContent='Tracking…';
};

/* ===== Live: Aircraft & Boats ===== */
const planeIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize:[24,24], iconAnchor:[12,12], className:'icon-veh' });
const boatIcon  = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/77/77521.png',    iconSize:[24,24], iconAnchor:[12,12], className:'icon-veh' });

let acTimer=null, boatTimer=null;

async function refreshAircraft(){
  try{
    const b=map.getBounds();
    const qs=new URLSearchParams({n:b.getNorth(),s:b.getSouth(),e:b.getEast(),w:b.getWest()});
    const r=await fetch(`${API_BASE}/api/opensky?${qs}`,{cache:'no-store'}); if(!r.ok) throw new Error('OpenSky '+r.status);
    const data=await r.json(); const states=data.states||[];
    aircraftLayer.clearLayers();
    states.forEach(s=>{
      const callsign=(s[1]||'').trim(); const lon=s[5], lat=s[6]; if(lat==null||lon==null) return;
      const gs=s[9]; const trk=s[10]; const alt=s[13];
      const pop=`<b>✈ ${callsign||'Unknown'}</b><br>Speed: ${gs?(gs*1.943844).toFixed(1)+' kn':'—'}<br>Track: ${trk==null?'—':Math.round(trk)+'°'}<br>Alt: ${alt==null?'—':Math.round(alt*3.28084)+' ft'}<br>ICAO24: ${s[0]||'—'}`;
      L.marker([lat,lon],{icon:planeIcon,rotationAngle:trk||0}).bindPopup(pop).addTo(aircraftLayer);
    });
  }catch(e){ console.warn(e); }
}

async function refreshBoats(){
  try{
    const r=await fetch(`${API_BASE}/api/ais`,{cache:'no-store'}); if(!r.ok) throw new Error('AIS '+r.status);
    const list=await r.json(); boatsLayer.clearLayers();
    (list||[]).forEach(v=>{
      if(v.lat==null||v.lon==null) return;
      const pop=`<b>⛵ ${v.name||v.mmsi||'Vessel'}</b><br>SOG: ${v.sog==null?'—':v.sog+' kn'}<br>COG: ${v.cog==null?'—':Math.round(v.cog)+'°'}<br>MMSI: ${v.mmsi||'—'}`;
      L.marker([v.lat,v.lon],{icon:boatIcon,rotationAngle:v.cog||0}).bindPopup(pop).addTo(boatsLayer);
    });
  }catch(e){ console.warn(e); }
}

/* ===== Overpass helpers (Rivers/Harbours/Fuel) ===== */
async function overpass(query){
  const r = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:query});
  if(!r.ok) throw new Error('Overpass '+r.status);
  return r.json();
}
function addPOI(layer, nodes, color='#f43', emoji='⚓'){
  nodes.forEach(n=>{
    if(!n.lat||!n.lon) return;
    const m=L.marker([n.lat,n.lon],{title:emoji}).bindPopup(`<b>${emoji} ${n.tags?.name||'Unnamed'}</b><br><small>${Object.entries(n.tags||{}).map(([k,v])=>`${k}: ${v}`).join('<br>')}</small>`);
    m.addTo(layer);
  });
}
async function loadRivers(){
  try{
    const b=map.getBounds(); const bbox=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()].join(',');
    const q=`[out:json][timeout:15];(way["waterway"~"river|stream|canal"](${bbox}););out geom;`;
    const data=await overpass(q); riversLayer.clearLayers();
    (data.elements||[]).forEach(w=>{
      if(!w.geometry) return;
      const latlngs=w.geometry.map(p=>[p.lat,p.lon]);
      L.polyline(latlngs,{color:'#62b0ff',weight:2,opacity:.8}).addTo(riversLayer);
    });
  }catch(e){ console.warn(e); }
}
async function loadHarbours(){
  try{
    const b=map.getBounds(); const bbox=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()].join(',');
    const q=`[out:json][timeout:15];(node["seamark:type"="harbour"](${bbox}); node["leisure"="marina"](${bbox}););out;`;
    const data=await overpass(q); harboursLayer.clearLayers(); addPOI(harboursLayer,data.elements||[], '#0ff','⚓');
  }catch(e){ console.warn(e); }
}
async function loadFuel(){
  try{
    const b=map.getBounds(); const bbox=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()].join(',');
    const q=`[out:json][timeout:15];(node["amenity"="fuel"](${bbox}); node["man_made"="pier"](${bbox}););out;`;
    const data=await overpass(q); fuelLayer.clearLayers(); addPOI(fuelLayer,data.elements||[], '#ff0','⛽');
  }catch(e){ console.warn(e); }
}

/* ===== bottom sheet wiring ===== */
const sheet=$('sheet'), fab=$('fab');
fab.onclick = ()=> sheet.classList.toggle('open');

document.querySelectorAll('input[name="basemap"]').forEach(r=>{
  r.addEventListener('change', e=>{
    const v=e.target.value;
    [baseOSM,baseOcean,baseSat,baseTopo].forEach(l=>map.removeLayer(l));
    if(v==='osm')   baseOSM.addTo(map);
    if(v==='ocean') baseOcean.addTo(map);
    if(v==='sat')   baseSat.addTo(map);
    if(v==='topo')  baseTopo.addTo(map);
  });
});
$('chkSeamarks').onchange = e => e.target.checked ? overlaySeamarks.addTo(map) : map.removeLayer(overlaySeamarks);
$('chkRivers').onchange   = e => { if(e.target.checked){ riversLayer.addTo(map); loadRivers(); map.on('moveend',loadRivers); } else { map.removeLayer(riversLayer); map.off('moveend',loadRivers);} };
$('chkHarbours').onchange = e => { if(e.target.checked){ harboursLayer.addTo(map); loadHarbours(); map.on('moveend',loadHarbours);} else { map.removeLayer(harboursLayer); map.off('moveend',loadHarbours);} };
$('chkFuel').onchange     = e => { if(e.target.checked){ fuelLayer.addTo(map); loadFuel(); map.on('moveend',loadFuel);} else { map.removeLayer(fuelLayer); map.off('moveend',loadFuel);} };

$('chkAircraft').onchange = e=>{
  if(e.target.checked){ aircraftLayer.addTo(map); refreshAircraft(); acTimer=setInterval(refreshAircraft,10000); }
  else { map.removeLayer(aircraftLayer); if(acTimer){clearInterval(acTimer); acTimer=null;} }
};
$('chkBoats').onchange    = e=>{
  if(e.target.checked){ boatsLayer.addTo(map); refreshBoats(); boatTimer=setInterval(refreshBoats,15000); }
  else { map.removeLayer(boatsLayer); if(boatTimer){clearInterval(boatTimer); boatTimer=null;} }
};

/* ===== boot ===== */
async function boot(){
  try{
    setStatus('Booting…'); initMap();
    const key = await getTioKey(); setStatus(`API base: ${API_BASE||'(same-origin)'} — key ✓`);

    $('btnGeo').onclick = async ()=>{ try{ clearErr(); const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000})); const {latitude,longitude}=pos.coords; const data=await tmrForecastByLatLon(latitude,longitude,key); setWX(data); map.setView([latitude,longitude], 11);}catch(e){showErr(e.message);} };
    $('btnCity').onclick = async ()=>{ try{ clearErr(); const name=($('city').value||'').trim(); if(!name) return; const loc=await tmrGeocodeCity(name,key); const data=await tmrForecastByLatLon(loc.lat,loc.lon,key); setWX(data); map.setView([loc.lat,loc.lon], 10);}catch(e){showErr(e.message);} };
  }catch(e){ showErr('Startup failed: '+e.message); setStatus('Failed to boot.'); }
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
